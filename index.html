<!DOCTYPE html>
<html lang="fr" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>DigComp 3.0 - Dashboard & Pilotage</title>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script
      src="https://8x8.vc/vpaas-magic-cookie-6d9b644a44dd43169d30c23ee93d243e/external_api.js"
      async
    ></script>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              darkbg: "#0f172a",
              darkpanel: "#1e293b",
              darkborder: "#334155",
            },
          },
        },
      };
    </script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .active-nav {
        border-right: 4px solid #2563eb;
        background-color: #eff6ff;
        color: #1e40af;
      }
      .dark .active-nav {
        background-color: #1e293b;
        color: #60a5fa;
        border-right-color: #60a5fa;
      }

      .badge-Basic {
        background-color: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
      }
      .badge-Intermediate {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }
      .badge-Advanced {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .badge-Highly-advanced {
        background-color: #f3e8ff;
        color: #6b21a8;
        border: 1px solid #e9d5ff;
      }

      .year-L1 {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .year-L2 {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
      }
      .year-L3 {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .msg-bubble {
        max-width: 85%;
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 0.85rem;
        word-wrap: break-word;
        position: relative;
      }
      .msg-own {
        background-color: #2563eb;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 2px;
      }
      .msg-other {
        background-color: #f3f4f6;
        color: #1f2937;
        border-bottom-left-radius: 2px;
      }
      .dark .msg-other {
        background-color: #334155;
        color: #e2e8f0;
      }

      .reaction-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e5e7eb;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 2px;
        transition: all 0.2s;
        color: #374151;
        margin-right: 2px;
        margin-top: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .reaction-badge.active {
        background: #eff6ff;
        border-color: #bfdbfe;
        color: #1d4ed8;
      }
      .msg-own .reaction-badge {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 4px;
      }
      .heatmap-cell {
        height: 35px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        transition: all 0.2s;
        cursor: help;
      }

      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
      }
      .typing-dots span {
        animation: blink 1.4s infinite both;
        height: 3px;
        width: 3px;
        background-color: #9ca3af;
        border-radius: 50%;
        display: inline-block;
        margin: 0 1px;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0% {
          opacity: 0.2;
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0.2;
        }
      }
      .status-online {
        width: 8px;
        height: 8px;
        background-color: #22c55e;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 2px #ffffff;
      }
      .status-idle {
        width: 8px;
        height: 8px;
        background-color: #f59e0b;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 0 2px #ffffff;
      }
      @keyframes pop {
        0% {
          transform: scale(0);
        }
        80% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      .badge-pop {
        animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      /* Markdown Styles */
      .prose h1,
      .prose h2,
      .prose h3 {
        font-weight: bold;
        margin-top: 1em;
        margin-bottom: 0.5em;
        color: #2563eb;
      }
      .dark .prose h1,
      .dark .prose h2,
      .dark .prose h3 {
        color: #60a5fa;
      }
      .prose ul {
        list-style-type: disc;
        padding-left: 1.2em;
        margin-bottom: 1em;
      }
      .prose strong {
        font-weight: bold;
      }
      .prose p {
        margin-bottom: 0.8em;
      }

      /* Dropdown Styles */
      .status-select-none {
        @apply border-gray-300 bg-white text-gray-500;
      }
      .dark .status-select-none {
        @apply border-gray-600 bg-gray-800 text-gray-400;
      }
      .status-select-draft {
        @apply border-amber-300 bg-amber-50 text-amber-700;
      }
      .dark .status-select-draft {
        @apply border-amber-700 bg-amber-900/50 text-amber-400;
      }
      .status-select-validated {
        @apply border-green-300 bg-green-50 text-green-700;
      }
      .dark .status-select-validated {
        @apply border-green-700 bg-green-900/50 text-green-400;
      }
      .status-select-obsolete {
        @apply border-red-300 bg-red-50 text-red-700;
      }
      .dark .status-select-obsolete {
        @apply border-red-700 bg-red-900/50 text-red-400;
      }

      /* Dashboard specific */
      .kpi-card {
        @apply bg-white dark:bg-darkpanel p-5 rounded-xl border dark:border-darkborder shadow-sm flex flex-col justify-between;
      }
      .kpi-title {
        @apply text-gray-500 dark:text-gray-400 text-xs uppercase font-bold tracking-wider mb-2;
      }
      .kpi-value {
        @apply text-3xl font-bold;
      }

      /* Animation des Toasts */
      .toast-enter-active,
      .toast-leave-active {
        transition: all 0.4s ease;
      }
      .toast-enter-from {
        opacity: 0;
        transform: translateX(100%); /* Arrive de la droite */
      }
      .toast-leave-to {
        opacity: 0;
        transform: translateX(100%); /* Repart vers la droite */
      }
    </style>
  </head>
  <body
    class="bg-gray-50 text-gray-800 dark:bg-darkbg dark:text-gray-100 transition-colors duration-200"
  >
    <div id="app" class="flex h-screen overflow-hidden relative">
      <div
        v-if="!user"
        class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-95 p-4"
      >
        <div
          class="bg-white dark:bg-darkpanel p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border dark:border-darkborder"
        >
          <i class="ph ph-graduation-cap text-6xl text-blue-600 mb-4"></i>
          <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">
            DigComp Pro
          </h2>
          <form @submit.prevent="login" class="space-y-4">
            <input
              type="email"
              v-model="authForm.email"
              class="w-full border dark:border-gray-600 dark:bg-gray-800 p-3 rounded outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Email"
              required
            />
            <input
              type="password"
              v-model="authForm.password"
              class="w-full border dark:border-gray-600 dark:bg-gray-800 p-3 rounded outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Mot de passe"
              required
            />
            <div
              v-if="authError"
              class="text-red-500 text-xs bg-red-50 dark:bg-red-900/20 p-2 rounded"
            >
              {{ authError }}
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded transition"
              :disabled="loading"
            >
              {{ loading ? 'Connexion...' : 'Entrer' }}
            </button>
          </form>
        </div>
      </div>

      <template v-else>
        <div
          class="md:hidden fixed top-0 left-0 right-0 h-16 bg-white dark:bg-darkpanel border-b border-gray-200 dark:border-darkborder z-30 flex items-center justify-between px-4 shadow-sm"
        >
          <button
            @click="isMobileMenuOpen = true"
            class="text-gray-700 dark:text-gray-200 p-2"
          >
            <i class="ph ph-list text-2xl"></i>
          </button>
          <h1 class="font-bold flex items-center gap-2">
            <i class="ph ph-tree-structure text-blue-600"></i> Maquette
          </h1>
          <div
            :class="['w-8 h-8 rounded-full flex items-center justify-center text-xs text-white font-bold shadow-sm', getUserColor(user.email)]"
          >
            {{ user.email.charAt(0).toUpperCase() }}
          </div>
        </div>

        <div
          v-if="isMobileMenuOpen"
          class="fixed inset-0 bg-black/50 z-40 md:hidden"
          @click="isMobileMenuOpen = false"
        ></div>

        <aside
          :class="['bg-white dark:bg-darkpanel shadow-xl overflow-y-auto flex-col border-r border-gray-200 dark:border-darkborder z-50 transition-transform duration-300 ease-in-out', 'fixed inset-y-0 left-0 w-80', 'md:relative md:flex md:translate-x-0', isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full']"
        >
          <div
            class="p-4 border-b border-gray-100 dark:border-darkborder space-y-4"
          >
            <div class="flex justify-between items-center">
              <h1 class="font-bold text-lg flex items-center gap-2">
                <i class="ph ph-student text-blue-600"></i> DigComp
              </h1>
              <div class="flex gap-2 relative">
                <button
                  @click="toggleDarkMode"
                  class="text-gray-400 hover:text-yellow-500"
                >
                  <i
                    :class="['ph text-lg', isDarkMode ? 'ph-sun' : 'ph-moon']"
                  ></i>
                </button>
                <button
                  @click="showActivityPanel = true"
                  class="text-gray-400 hover:text-blue-600"
                  title="Historique et activit√©"
                >
                  <i class="ph ph-clock-counter-clockwise text-lg"></i>
                </button>
                <button
                  @click="showSettingsModal = true"
                  class="text-gray-400 hover:text-blue-600"
                >
                  <i class="ph ph-gear text-lg"></i>
                </button>
                <button
                  @click="logout"
                  class="text-xs text-red-500 hover:underline"
                >
                  Sortir
                </button>
              </div>
            </div>

            <div
              class="bg-gray-100 dark:bg-gray-800 p-1 rounded-lg grid grid-cols-4 gap-1"
            >
              <button
                v-for="v in ['L1','L2','L3']"
                @click="changeView(v)"
                :class="[currentView === v ? ('bg-'+(v=='L1'?'red':v=='L2'?'amber':'emerald')+'-100 text-'+(v=='L1'?'red':v=='L2'?'amber':'emerald')+'-700 font-bold dark:bg-'+(v=='L1'?'red':v=='L2'?'amber':'emerald')+'-900/50 dark:text-'+(v=='L1'?'red':v=='L2'?'amber':'emerald')+'-200') : 'text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700', 'py-1.5 text-xs rounded transition']"
              >
                {{v}}
              </button>
              <button
                @click="changeView('Overview')"
                :class="[currentView === 'Overview' ? 'bg-slate-700 text-white' : 'text-gray-500 hover:bg-gray-200', 'py-1.5 text-xs rounded transition']"
              >
                <i class="ph ph-eye"></i>
              </button>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-2">
              <button
                @click="changeView('Dashboard')"
                :class="['py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition border', currentView === 'Dashboard' ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white dark:bg-darkpanel text-gray-600 dark:text-gray-300 border-gray-200 dark:border-darkborder hover:bg-gray-50 dark:hover:bg-gray-800']"
              >
                <i class="ph ph-chart-pie-slice"></i> Tableau de Bord
              </button>

              <button
                @click="loadSnapshots(); showTimeMachineModal = true"
                class="py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition bg-teal-50 dark:bg-teal-900/20 text-teal-600 dark:text-teal-300 hover:bg-teal-100 border border-teal-100 dark:border-teal-800 mt-2"
              >
                <i class="ph ph-clock-counter-clockwise"></i> Time Machine
              </button>
            </div>

            <div class="grid grid-cols-2 gap-2 mt-2">
              <button
                @click="changeView('Kanban')"
                class="bg-indigo-50 text-indigo-700 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 hover:bg-indigo-100"
              >
                <i class="ph ph-kanban"></i> Kanban
              </button>
              <button
                @click="openSunburst"
                class="bg-amber-50 text-amber-700 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 hover:bg-amber-100"
              >
                <i class="ph ph-sun"></i> Sunburst
              </button>
            </div>

            <button
  @click="showDataChatModal = true"
  class="w-full mt-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:shadow-lg transform hover:scale-[1.02]"
>
  <i class="ph ph-robot text-lg"></i> Assistant R√©f√©rentiel
</button>


            <button
              @click="showImportModal = true"
              class="w-full mt-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-300 hover:bg-purple-100 border border-purple-100 dark:border-purple-800"
            >
              <i class="ph ph-magic-wand text-lg"></i> Import Magique
            </button>

            <div
              v-if="pinnedCompetences.length > 0"
              class="border-t border-gray-100 dark:border-darkborder pt-2"
            >
              <p
                class="text-[10px] uppercase font-bold text-gray-400 mb-1 flex items-center gap-1"
              >
                <i class="ph ph-push-pin"></i> Favoris
              </p>
              <ul class="space-y-1">
                <li
                  v-for="pid in pinnedCompetences"
                  :key="pid"
                  @click="selectCompetenceById(pid)"
                  class="flex justify-between items-center group cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 px-2 py-1 rounded"
                >
                  <span
                    class="text-xs text-blue-600 dark:text-blue-400 truncate w-5/6"
                    >{{ getCompetenceName(pid) }}</span
                  >
                  <button
                    @click.stop="togglePin(pid)"
                    class="text-gray-400 hover:text-red-500"
                  >
                    <i class="ph ph-x"></i>
                  </button>
                </li>
              </ul>
            </div>

            <div
              class="bg-gray-50 dark:bg-gray-800/50 border dark:border-darkborder rounded-lg p-2"
            >
              <div class="flex justify-between items-center mb-2">
                <p
                  class="text-[10px] text-gray-400 uppercase font-bold flex items-center gap-1"
                >
                  <span class="status-online"></span> {{ connectedUsers.length
                  }} en ligne
                </p>
                <button
                  @click="requestNotifPermission"
                  class="text-gray-400 hover:text-blue-600"
                >
                  <i
                    :class="['ph', notifPermission==='granted'?'ph-bell-ringing':'ph-bell-slash']"
                  ></i>
                </button>
              </div>
              <div class="flex -space-x-2 overflow-hidden pb-1 pl-1">
                <div
                  v-for="u in connectedUsers.slice(0,8)"
                  :key="u.email"
                  :class="['relative w-6 h-6 rounded-full border-2 border-white dark:border-darkpanel flex items-center justify-center text-[9px] text-white font-bold', getUserColor(u.email)]"
                  :title="u.email"
                >
                  {{ u.email.charAt(0).toUpperCase() }}
                </div>
                <span
                  v-if="connectedUsers.length > 8"
                  class="text-[10px] text-gray-500 pl-3 self-center"
                  >+{{connectedUsers.length-8}}</span
                >
              </div>
            </div>
          </div>

          <div
            class="flex-1 overflow-y-auto"
            v-if="currentView !== 'Dashboard'"
          >
            <div v-for="domain in filteredTree" :key="domain.id">
              <div
                class="px-4 py-2 bg-gray-100 dark:bg-gray-800 font-bold text-gray-700 dark:text-gray-300 text-[11px] uppercase border-b dark:border-darkborder sticky top-0 z-10 flex justify-between"
              >
                <span class="truncate w-3/4">{{ domain.name }}</span>
                <span
                  class="bg-white dark:bg-gray-700 px-1.5 rounded font-mono text-[10px]"
                  >{{ Math.round(calculateDomainCoverage(domain)) }}%</span
                >
              </div>
              <ul>
                <li
                  v-for="comp in domain.competences"
                  :key="comp.id"
                  @click="selectCompetence(comp)"
                  :class="['px-5 py-2 text-xs cursor-pointer flex justify-between items-center border-l-4 transition-all', currentCompetence && currentCompetence.id === comp.id ? 'active-nav' : 'text-gray-600 dark:text-gray-400 border-transparent hover:bg-gray-50 dark:hover:bg-gray-800']"
                >
                  <span class="truncate w-3/4"
                    ><span class="font-bold opacity-50 mr-1"
                      >{{ comp.id.split('/').pop() }}</span
                    >{{ comp.name }}</span
                  >
                  <i
                    v-if="pinnedCompetences.includes(comp.id)"
                    class="ph ph-push-pin-fill text-blue-500 text-[10px]"
                  ></i>
                </li>
              </ul>
            </div>
          </div>
        </aside>

        <div
          :class="['fixed z-50 transition-all duration-300 bottom-4 right-20 w-14 h-14 rounded-full shadow-lg cursor-pointer flex items-center justify-center hover:scale-110 border-2 border-white', visioState.isActive ? 'bg-red-600 animate-pulse' : 'bg-rose-600 hover:bg-rose-700']"
          @click="toggleVisio"
          title="Salle de Classe Virtuelle"
        >
          <i
            :class="['ph text-2xl text-white', visioState.isOpen ? 'ph-arrow-down' : 'ph-video-camera']"
          ></i>

          <span
            v-if="visioState.isActive && !visioState.isOpen"
            class="absolute -top-1 -right-1 flex h-4 w-4"
          >
            <span
              class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
            ></span>
            <span
              class="relative inline-flex rounded-full h-4 w-4 bg-green-500 border border-white"
            ></span>
          </span>
        </div>

        <main
          v-if="currentView === 'Dashboard'"
          class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 dark:bg-darkbg"
        >
          <div class="max-w-6xl mx-auto space-y-6">
            <header class="mb-6">
              <h2
                class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2"
              >
                <i class="ph ph-chart-line-up text-blue-600"></i> Tableau de
                Bord Direction
              </h2>
              <p class="text-gray-500 text-sm">
                Indicateurs de performance et sant√© du r√©f√©rentiel.
              </p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="kpi-card border-l-4 border-l-blue-500">
                <div class="kpi-title">Comp√©tences Totales</div>
                <div class="kpi-value text-blue-600">
                  {{ dashboardStats.totalLOs }}
                </div>
              </div>
              <div class="kpi-card border-l-4 border-l-green-500">
                <div class="kpi-title">Couverture Globale</div>
                <div class="kpi-value text-green-600">
                  {{ dashboardStats.globalCoverage }}%
                </div>
              </div>
              <div class="kpi-card border-l-4 border-l-amber-500">
                <div class="kpi-title">En Brouillon</div>
                <div class="kpi-value text-amber-600">
                  {{ dashboardStats.draftCount }}
                </div>
              </div>
              <div class="kpi-card border-l-4 border-l-red-500">
                <div class="kpi-title">Alertes (No Res)</div>
                <div class="kpi-value text-red-600">
                  {{ dashboardStats.noResourceCount }}
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div
                class="bg-white dark:bg-darkpanel p-4 rounded-xl shadow-sm border dark:border-darkborder"
              >
                <h3
                  class="font-bold text-sm mb-4 text-gray-700 dark:text-gray-200"
                >
                  Progression par Ann√©e
                </h3>
                <div class="h-64"><canvas id="dashBarChart"></canvas></div>
              </div>
              <div
                class="bg-white dark:bg-darkpanel p-4 rounded-xl shadow-sm border dark:border-darkborder"
              >
                <h3
                  class="font-bold text-sm mb-4 text-gray-700 dark:text-gray-200"
                >
                  Sant√© du R√©f√©rentiel
                </h3>
                <div class="h-64 flex justify-center">
                  <canvas id="dashDoughnutChart"></canvas>
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-darkpanel p-4 rounded-xl shadow-sm border dark:border-darkborder"
            >
              <h3
                class="font-bold text-sm mb-4 text-gray-700 dark:text-gray-200"
              >
                R√©partition par Domaine
              </h3>
              <div class="h-80"><canvas id="dashRadarChart"></canvas></div>
            </div>
          </div>
        </main>

        <main
          v-if="currentView === 'Kanban'"
          class="flex-1 overflow-hidden flex flex-col bg-gray-100 dark:bg-darkbg"
        >
          <div
            class="h-16 border-b dark:border-darkborder bg-white dark:bg-darkpanel flex justify-between items-center px-6"
          >
            <h2 class="font-bold text-lg flex items-center gap-2">
              <i class="ph ph-kanban text-purple-600"></i> Workflow P√©dagogique
            </h2>
          </div>

          <div class="px-6 pb-4">
            <div
              class="bg-white dark:bg-darkpanel border dark:border-darkborder rounded-xl p-3 flex items-center justify-between shadow-sm"
            >
              <div class="flex items-center gap-2">
                <div
                  class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400"
                >
                  <i class="ph ph-chart-bar text-xl"></i>
                </div>
                <div>
                  <h3
                    class="text-xs font-bold text-gray-500 uppercase tracking-wide"
                  >
                    Total Valid√©s
                  </h3>
                  <div class="text-lg font-black text-gray-800 dark:text-white">
                    {{ kanbanOverview.total }}
                  </div>
                </div>
              </div>

              <div class="h-8 w-px bg-gray-200 dark:bg-gray-700"></div>

              <div class="flex items-center gap-3 ml-auto">
                <button
                  @click="onlyMyTasks = !onlyMyTasks"
                  :class="['px-3 py-1 text-xs font-bold rounded border transition flex items-center gap-2',
                                         onlyMyTasks ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 hover:bg-gray-50']"
                >
                  <i
                    :class="['ph', onlyMyTasks ? 'ph-check-square-offset' : 'ph-square']"
                  ></i>
                  Mes T√¢ches
                </button>

                <div
                  class="flex items-center gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg"
                >
                  <span
                    class="text-[10px] text-gray-500 px-2 font-bold uppercase"
                    >Vue :</span
                  >
                  <select
                    v-model="kanbanYear"
                    class="bg-white dark:bg-gray-700 text-sm border-none rounded-md py-1 pl-2 pr-8 focus:ring-0 cursor-pointer shadow-sm text-gray-700 dark:text-gray-200 font-bold"
                  >
                    <option value="Overview">üåç Globale (Tout)</option>
                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                    <option value="L1">Niveau L1</option>
                    <option value="L2">Niveau L2</option>
                    <option value="L3">Niveau L3</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="flex-1 overflow-x-auto p-4 flex gap-4">
            <div
              v-for="(col, key) in kanbanColumns"
              :key="key"
              class="w-72 flex-shrink-0 flex flex-col bg-gray-200 dark:bg-gray-800/50 rounded-xl"
              @dragover.prevent
              @drop="onDrop(key)"
            >
              <div
                :class="['p-3 font-bold text-sm uppercase flex justify-between border-t-4 rounded-t-xl', col.color, 'bg-white dark:bg-darkpanel']"
              >
                <span>{{ col.title }}</span>
                <span class="bg-gray-100 dark:bg-gray-700 px-2 rounded text-xs"
                  >{{ col.list.length }}</span
                >
              </div>

              <div class="flex-1 overflow-y-auto p-2 space-y-2">
                <div
                  v-for="item in col.list"
                  :key="item.id"
                  draggable="true"
                  @dragstart="draggedOutcome = item"
                  class="bg-white dark:bg-darkpanel p-3 rounded shadow-sm cursor-move border border-transparent hover:border-blue-400 group relative"
                >
                  <div
                    v-if="isLocked(item.id)"
                    class="absolute inset-0 bg-gray-100/80 dark:bg-gray-800/80 backdrop-blur-[1px] z-10 flex items-center justify-center rounded"
                  >
                    <span
                      class="text-xs font-bold text-red-500 flex items-center gap-1"
                      ><i class="ph ph-lock-key"></i> {{ getLockerName(item.id)
                      }}</span
                    >
                  </div>

                  <div
                    class="text-[10px] text-gray-400 mb-1 flex justify-between"
                  >
                    <span>{{ item.id }}</span>
                    <span class="font-mono text-purple-500"
                      >{{ item.level }}</span
                    >
                  </div>
                  <p
                    class="text-xs font-medium text-gray-800 dark:text-gray-200 line-clamp-3 mb-2"
                    v-html="highlightText(item.description)"
                  ></p>
                  <div
                    class="text-[9px] bg-gray-100 dark:bg-gray-700 p-1 rounded text-gray-500 truncate"
                    :title="item.domainName"
                  >
                    {{ item.compName }}
                  </div>

                  <template v-if="key !== 'none'">
                    <span
                      v-if="kanbanYear === 'Overview'"
                      :class="{'bg-green-100 text-green-800': item.displayYear === 'L1', 'bg-blue-100 text-blue-800': item.displayYear === 'L2', 'bg-purple-100 text-purple-800': item.displayYear === 'L3'}"
                      class="text-[9px] px-1.5 py-0.5 rounded font-bold mr-1 border border-black/5"
                    >
                      {{ item.displayYear }}
                    </span></template
                  >

                  <div
                    class="mt-2 pt-2 border-t dark:border-gray-700 flex justify-between items-center gap-2"
                  >
                    <div class="flex items-center flex-1 min-w-0">
                      <div
                        class="flex -space-x-1 mr-2"
                        v-if="item.assignees && item.assignees.length"
                      >
                        <div
                          v-for="person in item.assignees"
                          :key="person"
                          class="w-5 h-5 rounded-full bg-indigo-100 border border-white flex items-center justify-center text-[8px] font-bold text-indigo-800 uppercase flex-shrink-0"
                          :title="person"
                        >
                          {{ person.substring(0,2) }}
                        </div>
                      </div>

                      <span
                        v-else
                        class="text-[9px] text-gray-400 italic truncate"
                      >
                        Non assign√©
                      </span>
                    </div>

                    <div class="relative flex-shrink-0">
                      <i
                        class="ph ph-user-plus absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs pointer-events-none"
                      ></i>

                      <select
                        @change="e => { assignUserById(item.id, e.target.value); e.target.value = ''; }"
                        @click.stop
                        @mousedown.stop
                        class="appearance-none pl-6 pr-2 py-1 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 border border-transparent rounded-full text-[9px] font-bold text-gray-600 dark:text-gray-300 cursor-pointer outline-none focus:ring-1 focus:ring-indigo-500 transition w-auto max-w-[80px]"
                      >
                        <option value="" disabled selected>Assigner</option>

                        <option :value="user.email.split('@')[0]" v-if="user">
                          Moi
                        </option>

                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>

                        <option
                          v-for="u in connectedUsers"
                          :key="u.id"
                          :value="u.email.split('@')[0]"
                        >
                          {{ u.email.split('@')[0] }}
                        </option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <main
          v-else
          :class="['flex-1 overflow-y-auto relative flex flex-col pt-16 md:pt-0 transition-colors duration-300', viewBgClass]"
        >
          <div
            v-if="currentCompetence"
            class="flex-1 max-w-6xl mx-auto w-full p-4 md:p-8 space-y-6"
          >
            <header
              class="bg-white dark:bg-darkpanel p-6 rounded-xl shadow-sm border border-gray-200 dark:border-darkborder relative group"
            >
              <button
                @click.stop="togglePin(currentCompetence.id)"
                class="absolute top-4 right-4 text-2xl transition"
                :title="pinnedCompetences.includes(currentCompetence.id) ? 'Retirer' : 'Epingler'"
              >
                <i
                  :class="['ph', pinnedCompetences.includes(currentCompetence.id) ? 'ph-push-pin-fill text-blue-600' : 'ph-push-pin text-gray-300 hover:text-blue-600']"
                ></i>
              </button>

              <div class="flex justify-between items-start pr-8">
                <div>
                  <div
                    class="flex items-center gap-2 mb-1 text-gray-400 text-xs uppercase font-bold tracking-wider"
                  >
                    <span
                      :class="['px-2 py-0.5 rounded border', getViewBadgeClass()]"
                      >{{ currentView === 'Overview' ? 'Vue Globale' : 'Vue ' +
                      currentView }}</span
                    >
                    <span class="text-gray-400">{{ currentDomainName }}</span>
                  </div>
                  <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <span class="opacity-50 mr-2"
                      >{{ currentCompetence.id.split('/').pop() }}</span
                    >{{ currentCompetence.name }}
                  </h2>
                </div>
              </div>
              <p class="text-gray-600 dark:text-gray-400 text-sm mt-2">
                {{ currentCompetence.description }}
              </p>
              <div class="mt-4 flex items-center gap-3">
                <div
                  class="flex-1 h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden"
                >
                  <div
                    class="h-full bg-blue-600 transition-all duration-500"
                    :style="{width: calculateCompetenceCoverage(currentCompetence) + '%'}"
                  ></div>
                </div>
                <span class="text-xs font-bold text-blue-600 dark:text-blue-400"
                  >{{ Math.round(calculateCompetenceCoverage(currentCompetence))
                  }}%</span
                >
              </div>
            </header>

            <div
              :class="['flex flex-wrap justify-between items-center gap-2 sticky top-16 md:top-0 z-20 py-2', viewBgClass]"
            >
              <div
                class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar items-center"
              >
                <select
                  v-model="selectedComponentTag"
                  class="text-xs bg-white dark:bg-darkpanel border dark:border-darkborder rounded-full px-2 py-1.5 outline-none shadow-sm font-bold text-blue-600"
                >
                  <option value="">Toutes Composantes</option>
                  <option v-for="tag in availableTags" :key="tag" :value="tag">
                    {{ tag }} - {{ getLongName(tag) }}
                  </option>
                </select>
                <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <label
                  class="flex items-center gap-1 bg-white dark:bg-darkpanel px-3 py-1.5 rounded-full border dark:border-darkborder cursor-pointer shadow-sm hover:bg-gray-50"
                >
                  <input
                    type="checkbox"
                    v-model="showCheckedOnly"
                    class="rounded text-blue-600 focus:ring-0 w-3 h-3"
                  />
                  <span
                    class="text-xs font-bold text-gray-600 dark:text-gray-300"
                    >Valid√©s</span
                  >
                </label>
                <button
                  @click="onlyMyTasks = !onlyMyTasks"
                  :class="['px-3 py-1.5 rounded text-xs font-bold border flex items-center gap-2 transition', onlyMyTasks ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50']"
                >
                  <i
                    :class="['ph', onlyMyTasks ? 'ph-check-square-offset' : 'ph-square']"
                  ></i>
                  Mes T√¢ches
                </button>
                <button
                  v-for="lvl in ['All', 'Basic', 'Intermediate', 'Advanced', 'Highly advanced']"
                  @click="currentFilter = lvl"
                  :class="currentFilter === lvl ? 'bg-gray-800 text-white' : 'bg-white dark:bg-darkpanel border dark:border-darkborder text-gray-600 dark:text-gray-300'"
                  class="px-3 py-1.5 rounded-full text-xs font-medium transition shadow-sm whitespace-nowrap"
                >
                  {{ translateLevel(lvl) }}
                </button>
              </div>
              <div class="flex gap-2">
                <button
                  @click="exportDataExcel"
                  class="bg-green-600 text-white w-8 h-8 rounded flex items-center justify-center hover:bg-green-700"
                  title="Excel"
                >
                  <i class="ph ph-microsoft-excel-logo"></i>
                </button>
                <button
                  @click="exportToPixExcel"
                  class="bg-blue-800 text-white w-8 h-8 rounded flex items-center justify-center hover:bg-blue-900 transition"
                  title="Exporter vers format PIX"
                >
                  <span class="font-bold text-[10px]">Pix</span>
                </button>
                <button
                  @click="exportDataPDF"
                  class="bg-red-600 text-white w-8 h-8 rounded flex items-center justify-center hover:bg-red-700"
                  title="PDF"
                >
                  <i class="ph ph-file-pdf"></i>
                </button>
                <button
                  @click="openAddModal"
                  class="bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm hover:bg-blue-700 flex items-center gap-2"
                >
                  <i class="ph ph-plus"></i> Ajouter
                </button>
              </div>
            </div>

            <div class="space-y-3 pb-32">
              <div
                v-for="outcome in displayedOutcomes"
                :key="outcome.id"
                class="bg-white dark:bg-darkpanel p-4 rounded-lg border dark:border-darkborder shadow-sm group hover:border-blue-300 transition-colors relative"
                :class="{'opacity-75 pointer-events-none ring-2 ring-red-100': isLocked(outcome.id)}"
              >
                <div
                  v-if="isLocked(outcome.id)"
                  class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] px-2 py-1 rounded-full z-20 shadow-sm flex items-center gap-1 animate-pulse"
                >
                  <i class="ph ph-lock-key"></i> √âdit√© par {{
                  getLockerName(outcome.id) }}
                </div>

                <div class="flex items-start gap-3 pr-8">
                  <div
                    v-if="currentView !== 'Overview'"
                    class="pt-1 flex flex-col items-center gap-1"
                  >
                    <span
                      class="text-[9px] font-mono font-bold text-gray-400"
                      title="Identifiant du LO"
                      >{{ outcome.id }}</span
                    >
                    <select
                      :value="getMappingData(outcome, currentView).status"
                      @change="e => updateStatus(outcome, currentView, e.target.value)"
                      :class="['text-[10px] font-bold py-0.5 px-1 rounded border cursor-pointer outline-none appearance-none', getStatusClass(getMappingData(outcome, currentView).status)]"
                    >
                      <option value="none">üî¥ Non trait√©</option>
                      <option value="draft">üü† Brouillon</option>
                      <option value="review">üü° En relecture</option>
                      <option value="validated">üü¢ Valid√©</option>
                      <option value="obsolete">‚ö™ Obsol√®te</option>
                    </select>
                  </div>
                  <div v-else class="pt-1">
                    <i
                      v-if="isCoveredAnywhere(outcome)"
                      class="ph ph-check-circle text-green-500 text-xl"
                    ></i>
                    <i v-else class="ph ph-circle text-gray-300 text-xl"></i>
                  </div>

                  <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 mb-1">
                      <span
                        :class="['px-1.5 py-0.5 text-[9px] font-bold rounded uppercase border', getLevelBadgeClass(outcome.level)]"
                        >{{ translateLevel(outcome.level) }}</span
                      >
                      <span
                        v-if="outcome.isAI"
                        class="px-1.5 py-0.5 text-[9px] bg-indigo-50 text-indigo-700 border border-indigo-200 font-bold rounded"
                        >IA</span
                      >
                      <div
                        class="flex gap-1"
                        v-if="outcome.tags && outcome.tags.length"
                      >
                        <span
                          v-for="tag in outcome.tags"
                          :key="tag"
                          :title="getLongName(tag)"
                          class="px-1.5 py-0.5 text-[9px] bg-gray-100 text-gray-600 border border-gray-200 font-bold rounded"
                          >{{ tag }}</span
                        >
                      </div>
                      <template v-if="currentView === 'Overview'">
                        <span
                          v-if="isStatusActive(outcome, 'L1')"
                          class="year-L1 px-1.5 py-0.5 text-[9px] font-bold rounded border flex items-center gap-1"
                          >L1
                          <i
                            :class="['ph', getStatusIcon(getMappingData(outcome,'L1').status)]"
                          ></i
                        ></span>
                        <span
                          v-if="isStatusActive(outcome, 'L2')"
                          class="year-L2 px-1.5 py-0.5 text-[9px] font-bold rounded border flex items-center gap-1"
                          >L2
                          <i
                            :class="['ph', getStatusIcon(getMappingData(outcome,'L2').status)]"
                          ></i
                        ></span>
                        <span
                          v-if="isStatusActive(outcome, 'L3')"
                          class="year-L3 px-1.5 py-0.5 text-[9px] font-bold rounded border flex items-center gap-1"
                          >L3
                          <i
                            :class="['ph', getStatusIcon(getMappingData(outcome,'L3').status)]"
                          ></i
                        ></span>
                      </template>
                    </div>
                    <div class="relative group/desc">
    
                      <div v-if="editingOutcomeId !== outcome.id">
                          <p class="text-sm text-gray-800 dark:text-gray-200 leading-relaxed cursor-text" 
                             v-html="highlightText(outcome.description || outcome.text || '')"
                             @dblclick="startEditDescription(outcome)"
                             title="Double-cliquer pour √©diter">
                          </p>
                          <button @click="startEditDescription(outcome)" class="absolute top-0 right-0 opacity-0 group-hover/desc:opacity-100 text-gray-400 hover:text-blue-600 transition">
                              <i class="ph ph-pencil-simple"></i>
                          </button>
                      </div>
                  
                      <div v-else class="mt-2 animate-fade-in">
                          <textarea v-model="tempDescription" rows="4" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"></textarea>
                          <div class="flex justify-end gap-2 mt-2">
                              <button @click="editingOutcomeId = null" class="text-xs text-gray-500 hover:text-gray-700">Annuler</button>
                              <button @click="saveDescription(outcome)" class="text-xs bg-blue-600 text-white px-3 py-1 rounded font-bold hover:bg-blue-700">Enregistrer</button>
                          </div>
                      </div>
                  
                  </div>

                    <div
                      v-if="currentView !== 'Overview'"
                      class="mt-2 flex items-center gap-2 animate-fade-in"
                    >
                      <i class="ph ph-link text-gray-400"></i>
                      <a
                        v-if="getMappingData(outcome, currentView).courseLink"
                        :href="getMappingData(outcome, currentView).courseLink"
                        target="_blank"
                        class="text-blue-500 hover:text-blue-700 transition"
                        title="Ouvrir le lien"
                        ><i class="ph ph-arrow-square-out text-lg"></i
                      ></a>
                      <input
                        type="text"
                        @focus="requestLock(outcome.id)"
                        :value="getMappingData(outcome, currentView).courseLink"
                        @change="e => updateMapping(outcome, currentView, 'courseLink', e.target.value)"
                        placeholder="Lien du cours (Moodle/Drive)..."
                        class="flex-1 text-xs border-b border-gray-300 dark:border-gray-600 focus:border-blue-500 bg-transparent text-blue-600 outline-none py-1"
                      />
                    </div>
                    <div
                      v-else-if="isCoveredAnywhere(outcome)"
                      class="mt-2 space-y-1"
                    >
                      <div v-for="yr in ['L1','L2','L3']" :key="yr">
                        <div
                          v-if="isStatusActive(outcome, yr)"
                          class="text-[10px] text-gray-500 dark:text-gray-400 flex gap-1 items-center"
                        >
                          <span class="font-bold w-4">{{ yr }}:</span>
                          <a
                            v-if="getMappingData(outcome, yr).courseLink"
                            :href="getMappingData(outcome, yr).courseLink"
                            target="_blank"
                            class="text-blue-500 hover:underline truncate max-w-xs"
                            >{{ getMappingData(outcome, yr).courseLink }}</a
                          >
                          <span v-else class="italic opacity-50">Valid√©</span>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <div class="flex items-center gap-1 mb-2 ml-auto">
                        <div
                          class="flex -space-x-1 mr-2"
                          v-if="outcome.assignees && outcome.assignees.length"
                        >
                          <button
                            v-for="person in outcome.assignees"
                            :key="person"
                            @click="unassignUser(outcome, person)"
                            class="relative group w-6 h-6 rounded-full bg-indigo-100 border-2 border-white flex items-center justify-center text-[9px] font-bold text-indigo-800 uppercase transition-transform hover:scale-110 hover:z-10"
                            :title="'Cliquer pour retirer ' + person"
                          >
                            <span>{{ person.substring(0,2) }}</span>

                            <div
                              class="absolute inset-0 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                            >
                              <i class="ph ph-x"></i>
                            </div>
                          </button>
                        </div>

                        <div class="relative group">
                          <button
                            class="w-6 h-6 rounded-full bg-gray-100 border border-dashed border-gray-400 text-gray-500 hover:text-indigo-600 hover:border-indigo-600 flex items-center justify-center transition"
                          >
                            <i class="ph ph-plus"></i>
                          </button>

                          <select
                            @change="e => { assignUser(outcome, e.target.value); e.target.value = ''; }"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer text-xs"
                          >
                            <option value="" disabled selected>
                              Assigner...
                            </option>
                            <option
                              :value="user.email.split('@')[0]"
                              v-if="user"
                            >
                              Moi
                            </option>
                            <option
                              v-for="u in connectedUsers"
                              :key="u.id"
                              :value="u.email.split('@')[0]"
                            >
                              {{ u.email.split('@')[0] }}
                            </option>
                          </select>
                        </div>
                      </div>
                      <div
                        class="mb-2 flex flex-wrap gap-1 items-center bg-gray-50 dark:bg-gray-800 p-1 rounded"
                      >
                        <span
                          class="text-[9px] text-gray-400 font-bold uppercase mr-1"
                          >Tags:</span
                        >
                        <span
                          v-for="tag in outcome.tags"
                          :key="tag"
                          :title="getLongName(tag)"
                          class="px-1.5 py-0.5 text-[9px] bg-white dark:bg-gray-700 border rounded flex items-center gap-1"
                        >
                          {{ tag }}
                          <button
                            @click="removeTag(outcome, tag)"
                            class="text-red-400 hover:text-red-600"
                          >
                            &times;
                          </button>
                        </span>
                        <select
                          @change="e => addTag(outcome, e.target.value)"
                          class="text-[9px] border rounded bg-transparent outline-none"
                        >
                          <option value="">+ Tag</option>
                          <option
                            v-for="t in availableTags"
                            :key="t"
                            :value="t"
                          >
                            {{ t }} - {{ getLongName(t) }}
                          </option>
                        </select>
                      </div>
                    </div>

                    <div class="mt-3">
                      <button
                        @click="outcome.showResources = !outcome.showResources"
                        class="text-[10px] text-gray-500 hover:text-blue-600 flex items-center gap-1 font-bold"
                      >
                        <i
                          :class="['ph', outcome.showResources ? 'ph-caret-down' : 'ph-caret-right']"
                        ></i>
                        <i class="ph ph-folder-open"></i> Ressources & Documents
                        ({{ getResourcesCount(outcome) }})
                      </button>

                      <div
                        v-if="outcome.showResources"
                        class="mt-2 ml-2 pl-2 border-l-2 border-gray-100 dark:border-gray-700 animate-fade-in"
                      >
                        <div class="mb-2">
                          <button
                            @click="openResourceHunter(outcome)"
                            class="w-full py-1.5 border-2 border-dashed border-purple-300 text-purple-600 rounded bg-purple-50 hover:bg-purple-100 text-[10px] font-bold flex items-center justify-center gap-2 transition"
                          >
                            <i class="ph ph-detective text-sm"></i> Trouver des
                            ressources (IA)
                          </button>
                        </div>
                        <div v-for="(res, idx) in getAllResources(outcome)" :key="idx"
     class="flex flex-col text-xs py-2 hover:bg-gray-50 dark:hover:bg-gray-800 rounded px-2 group/res border-b border-gray-100 dark:border-gray-700 last:border-0">

    <div class="flex justify-between items-start">
        <div v-if="user !== '0'" class="flex items-center gap-2 truncate flex-1">
            <span :class="['px-1 rounded text-[9px] font-bold text-white', res.year==='L1'?'bg-red-400':(res.year==='L2'?'bg-amber-400':'bg-emerald-400')]">{{ res.year }}</span>

            <a :href="res.url" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1 truncate font-medium">
                <i :class="['ph', res.type === 'video' ? 'ph-youtube-logo' : 'ph-file-text']"></i>
                {{ res.title }}
            </a>

            <span v-if="res.aiAnalysis" class="flex items-center gap-1 text-[9px] text-gray-500 bg-gray-100 dark:bg-gray-700 px-1.5 rounded-full border border-gray-200 dark:border-gray-600" title="Temps estim√©">
                <i class="ph ph-clock"></i> {{ res.aiAnalysis.time }}
            </span>
        </div>

        <div class="flex items-center gap-1 opacity-0 group-hover/res:opacity-100 transition-opacity ml-2">
            <button @click.stop="analyzeResourceContent(outcome, res)"
                    :disabled="analyzingResId === res.url"
                    class="text-purple-400 hover:text-purple-600 hover:bg-purple-50 rounded p-1 transition"
                    title="Analyser le contenu avec l'IA">
                <i :class="['ph', analyzingResId === res.url ? 'ph-spinner animate-spin' : 'ph-sparkle']"></i>
            </button>

            <button @click.stop="openEditResource(outcome, res)" class="text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded p-1 transition">
                <i class="ph ph-pencil-simple text-sm"></i>
            </button>
            <button @click.stop="removeResource(outcome, res)" class="text-gray-400 hover:text-red-600 hover:bg-red-50 rounded p-1 transition">
                <i class="ph ph-trash text-sm"></i>
            </button>
        </div>
    </div>

    <div v-if="res.aiAnalysis" class="mt-1 pl-8 animate-fade-in">
        <p class="text-[10px] text-gray-600 dark:text-gray-300 italic border-l-2 border-purple-200 pl-2 mb-1">
            "{{ res.aiAnalysis.summary }}"
        </p>

        <div class="flex gap-1">
            <span v-for="tag in res.aiAnalysis.tags" :key="tag" class="text-[9px] bg-purple-50 text-purple-700 border border-purple-100 px-1.5 rounded">
                #{{ tag }}
            </span>
        </div>
    </div>
</div>
                        <div
                          v-if="currentView !== 'Overview'"
                          class="mt-2 flex gap-1 items-center"
                        >
                          <input
                            v-model="outcome.newResTitle"
                            placeholder="Titre..."
                            class="w-1/3 text-[10px] border rounded px-1 py-1 dark:bg-gray-800 dark:border-gray-600"
                          />
                          <input
                            v-model="outcome.newResUrl"
                            placeholder="URL..."
                            class="flex-1 text-[10px] border rounded px-1 py-1 dark:bg-gray-800 dark:border-gray-600"
                          />
                          <button
                            @click="addResource(outcome)"
                            class="text-blue-600 hover:bg-blue-50 p-1 rounded"
                          >
                            <i class="ph ph-plus-circle text-lg"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div
                      class="mt-3 pt-2 border-t border-gray-50 dark:border-gray-700 flex flex-wrap items-center gap-3"
                    >
                      <button
                        @click="openCommentModal(outcome)"
                        class="text-xs text-gray-400 hover:text-blue-600 flex items-center gap-1 transition"
                      >
                        <i class="ph ph-chat-teardrop-text text-lg"></i
                        ><span
                          v-if="getFilteredCommentsCount(outcome) > 0"
                          class="font-bold"
                          >{{ getFilteredCommentsCount(outcome) }}</span
                        ><span v-else>Discuter</span>
                      </button>
                      <div class="relative group/ai inline-block">
                        <button
                          class="text-xs text-purple-500 hover:text-purple-700 flex items-center gap-1 transition bg-purple-50 dark:bg-purple-900/20 px-2 py-0.5 rounded border border-purple-100 dark:border-purple-800"
                        >
                          <i class="ph ph-magic-wand"></i> ‚ú® Assistant IA
                        </button>
                        <div
                          class="absolute left-0 bottom-full mb-1 hidden group-hover/ai:block bg-white dark:bg-darkpanel shadow-xl border dark:border-darkborder rounded p-1 w-48 z-50"
                        >
                          <button
                            @click="generateAIContent(outcome, 'course')"
                            class="w-full text-left px-3 py-2 text-xs hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded flex items-center gap-2"
                          >
                            üìÑ G√©n√©rer un Cours
                          </button>
                          <button
                            @click="generateAIContent(outcome, 'td')"
                            class="w-full text-left px-3 py-2 text-xs hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded flex items-center gap-2"
                          >
                            üìù G√©n√©rer un TD
                          </button>
                          <button
                            @click="generateAIContent(outcome, 'qcm')"
                            class="w-full text-left px-3 py-2 text-xs hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded flex items-center gap-2"
                          >
                            ‚ùì G√©n√©rer un QCM
                          </button>
                          <button
                            @click="generateAIContent(outcome, 'practice')"
                            class="w-full text-left px-3 py-2 text-xs hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded flex items-center gap-2"
                          >
                            üíª Exercice Pratique
                          </button>
                        </div>
                      </div>
                      <button
                        @click="openLOHistory(outcome)"
                        class="text-xs text-gray-400 hover:text-blue-600 flex items-center gap-1 transition"
                      >
                        <i class="ph ph-clock text-lg"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <button
                  v-if="outcome.isCustom && currentView!=='Overview'"
                  @click="deleteOutcome(outcome)"
                  class="absolute top-3 right-3 text-gray-300 hover:text-red-500"
                >
                  <i class="ph ph-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <div
            v-else
            class="flex-1 flex flex-col items-center justify-center text-gray-400 p-8 text-center"
          >
            <i
              class="ph ph-cursor-click text-5xl mb-4 opacity-30 text-blue-500"
            ></i>
            <p class="text-lg">S√©lectionnez une comp√©tence.</p>
          </div>
        </main>

        <div :class="['fixed z-50 bg-white dark:bg-darkpanel shadow-2xl flex flex-col transition-all duration-300 border-t border-gray-200 dark:border-darkborder', showChat ? 'bottom-0 right-0 w-full h-[60vh] md:w-80 md:h-[450px] md:bottom-4 md:right-6 md:rounded-t-xl' : 'bottom-4 right-4 w-14 h-14 rounded-full overflow-visible']">

            <div @click="toggleChat" :class="['bg-blue-600 text-white flex justify-between items-center cursor-pointer hover:bg-blue-700 text-xs font-bold transition flex-shrink-0 h-14 px-3', showChat ? 'rounded-t-xl' : 'justify-center rounded-full']">
                <div v-if="showChat" class="flex items-center gap-2">
                    <i class="ph ph-chats-circle text-base"></i> Chat
                    <span v-if="unreadCount>0" class="bg-red-500 px-1.5 rounded-full badge-pop">{{unreadCount}}</span>
                </div>
                <div v-else class="w-full h-full flex items-center justify-center relative">
                    <i class="ph ph-chat-circle-dots text-2xl"></i>
                    <span v-if="unreadCount > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">{{ unreadCount }}</span>
                </div>
                <i v-if="showChat" class="ph ph-caret-down"></i>
            </div>

            <div v-if="showChat" ref="chatBox" class="flex-1 bg-gray-50 dark:bg-gray-900 p-2 overflow-y-auto space-y-2">
                <div v-for="msg in chatMessages" :key="msg.id" class="flex flex-col gap-1">
                    <div :class="['msg-bubble shadow-sm group relative', msg.sender === user.email ? 'msg-own' : 'msg-other']">

                        <div v-if="msg.sender !== user.email" class="text-[9px] font-bold opacity-60 mb-0.5">{{ msg.sender.split('@')[0] }}</div>

                        <div v-if="msg.attachmentType === 'image'" class="mb-1 mt-1">
                            <img :src="msg.attachment" class="max-w-[200px] max-h-40 rounded-lg border border-white/20 object-cover cursor-pointer hover:opacity-90 transition" @click="window.open(msg.attachment)" title="Agrandir">
                        </div>

                        <div v-else-if="msg.attachmentType === 'file'" class="flex items-center gap-2 bg-black/5 dark:bg-white/10 p-2 rounded mb-1 max-w-[200px]">
                            <div class="bg-white dark:bg-gray-600 p-1.5 rounded text-blue-500"><i class="ph ph-file text-lg"></i></div>
                            <div class="flex-1 overflow-hidden">
                                <a :href="msg.attachment" :download="msg.attachmentName" class="text-xs underline truncate block font-bold">{{ msg.attachmentName }}</a>
                                <span class="text-[9px] opacity-70 uppercase">Fichier</span>
                            </div>
                        </div>

                        <div v-else class="text-sm break-words" v-html="formatMessage(msg.text)"></div>

                        <div class="absolute -top-6 hidden group-hover:flex bg-white dark:bg-gray-700 shadow-sm rounded-full p-1 gap-1 z-10">
                            <button v-for="e in ['üëç','‚ù§Ô∏è','üòÇ','üî•']" @click="toggleReaction(msg, e)" class="hover:bg-gray-100 dark:hover:bg-gray-600 rounded px-1 text-sm transition">{{e}}</button>
                        </div>
                        <div v-if="msg.reactions" class="flex flex-wrap gap-1 mt-1 justify-end">
                            <span v-for="(users, e) in msg.reactions" :key="e" @click="toggleReaction(msg, e)" :class="['reaction-badge', users.includes(user.email) ? 'active' : '']">{{ e }} {{ users.length }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showChat" class="p-2 border-t dark:border-darkborder bg-white dark:bg-darkpanel flex gap-2 relative flex-shrink-0 pb-safe items-end">
                <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden">

                <button @click="triggerFileInput" class="text-gray-400 hover:text-blue-600 mb-2 transition" title="Envoyer fichier/image">
                    <i class="ph ph-paperclip text-lg"></i>
                </button>

                <div v-if="usersTypingText" class="absolute -top-6 left-4 text-[10px] text-gray-500 dark:text-gray-400 italic flex items-center gap-1 bg-white/90 dark:bg-darkpanel/90 px-2 py-0.5 rounded-t-lg shadow-sm">
                    <span class="typing-dots"><span></span><span></span><span></span></span> {{ usersTypingText }} √©crit...
                </div>

                <textarea v-model="newMessage"
                          @keyup.enter.exact="sendMessage"
                          @input="handleTyping"
                          @paste="handlePaste"
                          class="flex-1 text-xs border dark:border-gray-600 dark:bg-gray-800 rounded-xl px-3 py-2 outline-none resize-none focus:ring-1 focus:ring-blue-500 transition"
                          rows="1"
                          placeholder="Message... (Ctrl+V pour image)"></textarea>

                <button @click="sendMessage" class="text-blue-600 mb-2 hover:scale-110 transition">
                    <i class="ph ph-paper-plane-right text-lg"></i>
                </button>
            </div>
        </div>
      </template>

      <!-- MODALE CHAT WITH DATA -->
<div
v-if="showDataChatModal"
class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
@click.self="showDataChatModal=false"
>
<div class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col overflow-hidden">
  <!-- Header -->
  <div class="p-4 border-b dark:border-darkborder bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex justify-between items-center">
    <h3 class="font-bold flex items-center gap-2">
      <i class="ph ph-robot"></i> Assistant R√©f√©rentiel (Data Chat)
    </h3>
    <button @click="showDataChatModal=false">
      <i class="ph ph-x text-lg"></i>
    </button>
  </div>

  <!-- Zone de r√©ponse -->
  <div class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-darkbg">
    <div v-if="!dataChatResponse && !dataChatLoading" class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
      <i class="ph ph-chat-teardrop-text text-6xl mb-4"></i>
      <p class="text-center text-sm">Posez une question sur l'√©tat d'avancement,<br>les ressources manquantes ou les statistiques.</p>
      <div class="mt-4 flex flex-wrap gap-2 justify-center">
          <span @click="dataChatQuery='Quelles comp√©tences n\'ont aucune ressource en L2 ?'; askDataAssistant()" class="cursor-pointer bg-white dark:bg-gray-800 border px-2 py-1 rounded text-xs hover:border-blue-500">üîç Manque de ressources L2 ?</span>
          <span @click="dataChatQuery='Fais moi un r√©sum√© global de l\'avancement (pourcentage valid√© par domaine).'; askDataAssistant()" class="cursor-pointer bg-white dark:bg-gray-800 border px-2 py-1 rounded text-xs hover:border-blue-500">üìä R√©sum√© avancement</span>
          <span @click="dataChatQuery='Liste les comp√©tences assign√©es √† [Moi] qui sont encore en brouillon.'; askDataAssistant()" class="cursor-pointer bg-white dark:bg-gray-800 border px-2 py-1 rounded text-xs hover:border-blue-500">üìù Mes brouillons</span>
      </div>
    </div>

    <div v-if="dataChatLoading" class="flex flex-col items-center justify-center h-full space-y-4">
      <i class="ph ph-spinner animate-spin text-4xl text-blue-600"></i>
      <p class="text-sm text-gray-500 animate-pulse">Analyse du r√©f√©rentiel en cours...</p>
    </div>

    <div v-if="dataChatResponse" class="prose dark:prose-invert max-w-none text-sm">
      <!-- On r√©utilise votre fonction markdownToHtml existante -->
      <div v-html="markdownToHtml(dataChatResponse)"></div>
    </div>
  </div>

  <!-- Zone de saisie -->
  <div class="p-4 bg-white dark:bg-darkpanel border-t dark:border-darkborder">
    <div class="flex gap-2">
      <input
        v-model="dataChatQuery"
        @keyup.enter="askDataAssistant"
        placeholder="Posez votre question sur les donn√©es..."
        class="flex-1 border dark:border-gray-600 dark:bg-gray-800 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
      />
      <button
        @click="askDataAssistant"
        :disabled="dataChatLoading || !dataChatQuery"
        class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 transition flex items-center gap-2"
      >
        <i class="ph ph-paper-plane-right"></i>
      </button>
    </div>
  </div>
</div>
</div>


      <div
        v-if="showAIModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showAIModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh]"
        >
          <div
            class="p-4 border-b dark:border-darkborder flex justify-between items-center bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-t-xl"
          >
            <h3 class="font-bold flex items-center gap-2">
              <i class="ph ph-magic-wand"></i> Assistant P√©dagogique ({{
              currentAIType }})
            </h3>
            <button @click="showAIModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div
            class="p-6 overflow-y-auto prose dark:prose-invert max-w-none flex-1 text-sm"
          >
            <div
              v-if="aiLoading"
              class="flex flex-col items-center justify-center h-40 space-y-3"
            >
              <i
                class="ph ph-spinner animate-spin text-4xl text-purple-600"
              ></i>
              <p class="text-gray-500">L'IA r√©fl√©chit...</p>
            </div>
            <div
              v-else-if="aiError"
              class="text-red-500 bg-red-50 p-4 rounded text-center"
            >
              {{ aiError }}
            </div>
            <div v-else v-html="markdownToHtml(aiResult)"></div>
          </div>
          <div
            class="p-4 border-t dark:border-darkborder flex justify-end gap-2 bg-gray-50 dark:bg-gray-800/50"
          >
            <button
              @click="generateAIContent(currentOutcomeForAI, currentAIType)"
              class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded text-sm font-bold hover:bg-gray-300"
            >
              R√©g√©n√©rer</button
            ><button
              @click="showAIModal=false"
              class="px-4 py-2 bg-purple-600 text-white rounded text-sm font-bold hover:bg-purple-700"
            >
              Fermer</button
            ><button
              v-if="currentAIType === 'qcm' && aiResult && !aiLoading"
              @click="exportMoodleXML"
              class="px-4 py-2 bg-orange-100 text-orange-700 border border-orange-200 rounded text-sm font-bold hover:bg-orange-200 mr-auto flex items-center gap-2"
            >
              <i class="ph ph-download-simple"></i> Moodle XML
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showHunterModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showHunterModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-gradient-to-r from-purple-600 to-indigo-600 text-white flex justify-between items-center"
          >
            <h3 class="font-bold flex items-center gap-2">
              <i class="ph ph-detective"></i> Chasseur de Ressources
            </h3>
            <button @click="showHunterModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>

          <div
            class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-darkbg flex flex-col md:flex-row gap-6"
          >
            <div class="md:w-1/3 space-y-6">
              <div
                v-if="!hunterSearchTerms && !hunterLoading"
                class="text-center p-6 bg-white dark:bg-darkpanel rounded-xl border dark:border-darkborder shadow-sm"
              >
                <i class="ph ph-magic-wand text-4xl text-purple-500 mb-3"></i>
                <h4 class="font-bold text-gray-800 dark:text-white mb-2">
                  Assistant de Recherche
                </h4>
                <p class="text-xs text-gray-500 mb-4">
                  L'IA va analyser la comp√©tence et pr√©parer vos recherches.
                </p>
                <button
                  @click="launchHunter"
                  class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold shadow hover:bg-purple-700 transition transform active:scale-95"
                >
                  Lancer l'analyse
                </button>
              </div>

              <div v-if="hunterLoading" class="text-center p-8">
                <i
                  class="ph ph-spinner animate-spin text-3xl text-purple-600"
                ></i>
                <p class="text-xs text-gray-400 mt-2">
                  G√©n√©ration des strat√©gies...
                </p>
              </div>

              <div
                v-if="hunterSearchTerms"
                class="space-y-4 animate-fade-in-up"
              >
                <div
                  class="bg-white dark:bg-darkpanel p-4 rounded-xl shadow-sm border dark:border-darkborder"
                >
                  <h4
                    class="font-bold text-[10px] text-gray-400 uppercase tracking-wider mb-3"
                  >
                    1. Explorer le web
                  </h4>

                  <a
                    :href="'https://www.youtube.com/results?search_query=' + encodeURIComponent(hunterSearchTerms.yt_query)"
                    target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 border border-red-100 transition group mb-2 text-left"
                  >
                    <i class="ph ph-youtube-logo text-2xl flex-shrink-0"></i>
                    <div class="flex-1 min-w-0">
                      <div class="font-bold text-xs">Chercher sur YouTube</div>
                      <div class="text-[10px] opacity-70 truncate">
                        "{{ hunterSearchTerms.yt_query }}"
                      </div>
                    </div>
                    <i
                      class="ph ph-arrow-square-out text-lg opacity-0 group-hover:opacity-100 transition"
                    ></i>
                  </a>

                  <a
                    :href="'https://www.google.com/search?q=' + encodeURIComponent(hunterSearchTerms.google_query)"
                    target="_blank"
                    class="flex items-center gap-3 p-3 rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-100 transition group text-left"
                  >
                    <i class="ph ph-google-logo text-2xl flex-shrink-0"></i>
                    <div class="flex-1 min-w-0">
                      <div class="font-bold text-xs">Chercher sur Google</div>
                      <div class="text-[10px] opacity-70 truncate">
                        "{{ hunterSearchTerms.google_query }}"
                      </div>
                    </div>
                    <i
                      class="ph ph-arrow-square-out text-lg opacity-0 group-hover:opacity-100 transition"
                    ></i>
                  </a>
                </div>

                <div
                  class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800"
                >
                  <h4
                    class="font-bold text-[10px] text-indigo-400 uppercase tracking-wider mb-2"
                  >
                    2. R√©cup√©rer le lien
                  </h4>
                  <div class="flex gap-2">
                    <input
                      v-model="magicUrlInput"
                      @keyup.enter="handleMagicPaste"
                      placeholder="Coller l'URL ici (Ctrl+V)"
                      class="flex-1 text-xs p-2 rounded border border-indigo-200 outline-none focus:border-indigo-500 dark:bg-gray-800 dark:border-gray-600"
                    />
                    <button
                      @click="handleMagicPaste"
                      :disabled="magicLoading"
                      class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 disabled:opacity-50 transition"
                    >
                      <i
                        :class="['ph', magicLoading ? 'ph-spinner animate-spin' : 'ph-plus']"
                      ></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div
              class="flex-1 bg-gray-100 dark:bg-gray-800/50 rounded-xl p-4 border dark:border-darkborder min-h-[300px] flex flex-col"
            >
              <h4
                class="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2"
              >
                <i class="ph ph-basket"></i> Ressources Trouv√©es
                <span
                  v-if="hunterResults?.suggestions"
                  class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] px-1.5 rounded-full"
                  >{{ hunterResults.suggestions.length }}</span
                >
              </h4>

              <div
                v-if="!hunterResults || !hunterResults.suggestions || hunterResults.suggestions.length === 0"
                class="flex-1 flex flex-col items-center justify-center text-gray-400 opacity-60"
              >
                <i class="ph ph-ghost text-4xl mb-2"></i>
                <p class="text-xs text-center">
                  Le panier est vide.<br />Lancez l'analyse ou collez un lien.
                </p>
              </div>

              <div v-else class="space-y-3 overflow-y-auto max-h-[500px] pr-2">
                <div
                  v-for="(res, i) in hunterResults.suggestions"
                  :key="res.url + i"
                  class="bg-white dark:bg-darkpanel p-3 rounded-lg shadow-sm border border-transparent hover:border-purple-300 group flex gap-3 animate-fade-in-left transition-all"
                >
                  <div
                    v-if="res.thumbnail"
                    class="w-24 h-16 bg-gray-200 rounded overflow-hidden flex-shrink-0 relative"
                  >
                    <img
                      :src="res.thumbnail"
                      class="w-full h-full object-cover"
                    />
                    <div
                      v-if="res.url.includes('youtu')"
                      class="absolute inset-0 flex items-center justify-center bg-black/20"
                    >
                      <i class="ph ph-play-circle text-white text-xl"></i>
                    </div>
                  </div>
                  <div
                    v-else
                    class="w-24 h-16 bg-gray-100 dark:bg-gray-700 rounded flex items-center justify-center text-gray-400 flex-shrink-0"
                  >
                    <i class="ph ph-link text-2xl"></i>
                  </div>

                  <div class="flex-1 min-w-0 flex flex-col justify-between">
                    <div>
                      <div
                        class="font-bold text-xs text-gray-800 dark:text-gray-200 line-clamp-1"
                        :title="res.title"
                      >
                        {{ res.title }}
                      </div>

                      <a
                        :href="res.url"
                        target="_blank"
                        class="text-[10px] text-blue-500 hover:underline truncate block opacity-80"
                        :title="res.url"
                      >
                        {{ shortUrl(res.url) }}
                      </a>

                      <p
                        v-if="res.snippet"
                        class="text-[9px] text-gray-500 line-clamp-1 mt-0.5"
                      >
                        {{ res.snippet }}
                      </p>
                    </div>

                    <div class="flex justify-between items-end mt-2">
                      <span
                        v-if="res.isAuto"
                        class="text-[9px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold"
                        >Suggestion Auto</span
                      >
                      <span
                        v-else
                        class="text-[9px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-bold"
                        >Import√©</span
                      >

                      <button
                        @click="adoptResource(res)"
                        class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold hover:bg-green-700 shadow-sm transition transform active:scale-95 flex items-center gap-1"
                      >
                        <i class="ph ph-plus"></i> Ajouter au cours
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        v-if="showSunburstModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showSunburstModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col"
        >
          <div
            class="p-4 border-b dark:border-darkborder flex justify-between items-center"
          >
            <h3 class="font-bold text-lg">Explorateur Solaire (Sunburst)</h3>
            <button @click="showSunburstModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="flex-1 p-4 relative">
            <div id="sunburstChart" class="w-full h-full"></div>
          </div>
        </div>
      </div>

      <div
        v-show="visioState.isOpen"
        class="fixed z-50 flex flex-col bg-white dark:bg-darkpanel border-2 border-rose-600 shadow-2xl rounded-xl overflow-hidden"
        :style="{ top: visioState.y + 'px', left: visioState.x + 'px', width: '600px', height: '450px' }"
      >
        <div
          @mousedown="startDragVisio"
          class="bg-rose-600 text-white px-3 py-2 flex justify-between items-center cursor-move select-none"
        >
          <span class="text-xs font-bold flex items-center gap-2"
            ><i class="ph ph-video-camera"></i> Classe Virtuelle</span
          >
          <div class="flex gap-2" @mousedown.stop>
            <button
              @click="visioState.isOpen = false"
              title="R√©duire"
              class="hover:bg-rose-700 rounded p-1"
            >
              <i class="ph ph-minus"></i>
            </button>
          </div>
        </div>

        <div id="jaas-container" class="flex-1 bg-black relative"></div>
      </div>

      <div
        v-if="visioState.show"
        class="fixed z-50 flex flex-col bg-white dark:bg-darkpanel border-2 border-rose-500 shadow-2xl rounded-lg overflow-hidden transition-shadow"
        :style="{
                top: visioState.y + 'px',
                left: visioState.x + 'px',
                width: visioState.minimized ? '250px' : '600px',
                height: visioState.minimized ? 'auto' : '450px',
                resize: visioState.minimized ? 'none' : 'both'
             }"
        style="min-width: 250px; min-height: 40px"
      >
        <div
          @mousedown="startDragVisio"
          class="bg-rose-600 text-white p-2 flex justify-between items-center cursor-move select-none flex-shrink-0"
        >
          <div class="flex items-center gap-2 text-xs font-bold truncate">
            <i class="ph ph-video-camera"></i>
            <span v-if="!visioState.minimized">Salle de Classe</span>
          </div>
          <div class="flex gap-1" @mousedown.stop>
            <button
              @click="visioState.minimized = !visioState.minimized"
              class="hover:bg-rose-700 p-1 rounded"
              :title="visioState.minimized ? 'Agrandir' : 'R√©duire'"
            >
              <i
                :class="['ph', visioState.minimized ? 'ph-corners-out' : 'ph-minus']"
              ></i>
            </button>
            <button
              @click="visioState.show = false"
              class="hover:bg-red-800 p-1 rounded"
            >
              <i class="ph ph-x"></i>
            </button>
          </div>
        </div>

        <div
          v-show="!visioState.minimized"
          class="flex-1 bg-black relative w-full h-full"
        >
          <div
            v-if="visioState.dragging"
            class="absolute inset-0 z-10 bg-transparent"
          ></div>

          <iframe
            src="https://meet.jit.si/DigComp_Room_Public_123456?config.startWithAudioMuted=true&config.startWithVideoMuted=true"
            allow="camera; microphone; fullscreen; display-capture; autoplay"
            class="w-full h-full border-0"
          >
          </iframe>
        </div>
      </div>

      <div
        v-if="showLOHistoryModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showLOHistoryModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-lg h-[500px] flex flex-col"
        >
          <div
            class="p-4 border-b dark:border-darkborder flex justify-between items-center"
          >
            <h3 class="font-bold dark:text-white truncate pr-4">
              Historique: {{ currentHistoryOutcomeTitle }}
            </h3>
            <button @click="showLOHistoryModal=false" class="text-gray-400">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-2">
            <div
              v-if="currentLOHistory.length === 0"
              class="text-center text-gray-400 text-xs italic mt-10"
            >
              Aucun historique pour ce LO en {{ currentView }}.
            </div>
            <div
              v-for="log in currentLOHistory"
              :key="log.id"
              class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700/30 rounded border dark:border-darkborder text-xs"
            >
              <div class="flex-1">
                <div class="flex justify-between mb-1">
                  <span class="font-bold text-blue-600 dark:text-blue-400"
                    >{{ log.user }}</span
                  ><span class="text-gray-400"
                    >{{ new Date(log.timestamp).toLocaleString() }}</span
                  >
                </div>
                <div class="text-gray-700 dark:text-gray-300 mt-1">
    
                  <span v-if="log.action==='status_change'">
                      Statut: {{ getStatusLabel(log.oldVal) }} <i class="ph ph-arrow-right mx-1"></i> <span class="font-bold">{{ getStatusLabel(log.newVal) }}</span>
                  </span>
              
                  <div v-else-if="log.action==='desc_edit'" class="bg-white dark:bg-gray-800 p-2 rounded border dark:border-gray-600 text-[11px] leading-relaxed">
                      <div class="font-bold text-gray-400 mb-1">Diff√©rence :</div>
                      <div v-html="getDiffHtml(log.oldVal, log.newVal)"></div>
                  </div>
              
                  <div v-else-if="log.action==='link'" class="text-blue-600">
                      <span class="line-through text-gray-400 text-[10px] mr-1">{{ log.oldVal || 'Vide' }}</span> 
                      <i class="ph ph-arrow-right"></i> 
                      <span class="font-bold ml-1">{{ log.newVal }}</span>
                  </div>
                  <span v-else-if="log.action==='add_resource'" class="text-purple-600 font-bold">Doc ajout√©: {{ log.newVal }}</span>
                  <span v-else-if="log.action==='remove_resource'" class="text-orange-600 font-bold">Doc supprim√©: {{ log.oldVal }}</span>
              
              </div>
                <div class="mt-1 text-[10px] text-gray-500 font-mono">
                  {{ log.year }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        v-if="showHistoryModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showHistoryModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-xl h-[600px] flex flex-col"
        >
          <div
            class="p-4 border-b dark:border-darkborder flex justify-between items-center"
          >
            <h3 class="font-bold dark:text-white">Historique Global</h3>
            <button @click="showHistoryModal=false" class="text-gray-400">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-2">
            <div
              v-for="log in historyLogs"
              :key="log.id"
              class="flex items-center gap-3 p-3 bg-gray-50 dark:bg-gray-700/30 rounded border dark:border-darkborder text-xs"
            >
              <div class="flex-1">
                <div class="flex justify-between mb-1">
                  <span class="font-bold text-blue-600 dark:text-blue-400"
                    >{{ log.user }}</span
                  ><span class="text-gray-400"
                    >{{ new Date(log.timestamp).toLocaleString() }}</span
                  >
                </div>
                <div class="text-gray-700 dark:text-gray-300">
                  <span v-if="log.action==='status_change'"
                    >Statut: {{ getStatusLabel(log.oldVal) }} ->
                    <span class="font-bold"
                      >{{ getStatusLabel(log.newVal) }}</span
                    ></span
                  >
                  <div v-else-if="log.action==='link'">
                    <span class="line-through text-gray-400"
                      >{{ log.oldVal }}</span
                    >
                    -> {{ log.newVal }}
                  </div>
                  <span v-else>{{ log.desc }}</span>
                </div>
                <div class="mt-1 text-[10px] text-gray-500 font-mono">
                  {{ log.targetId }} ({{ log.year }})
                </div>
              </div>
              <button
                @click="restoreState(log)"
                class="text-orange-500 hover:text-orange-600 flex flex-col items-center gap-1"
                title="Annuler"
              >
                <i class="ph ph-arrow-u-up-left text-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        v-if="showSettingsModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showSettingsModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center"
          >
            <h3 class="font-bold text-gray-800 dark:text-white">Param√®tres</h3>
            <button
              @click="showSettingsModal=false"
              class="text-gray-400 hover:text-red-500"
            >
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="p-6 space-y-4 overflow-y-auto flex-1">
            <label
              class="block text-sm font-bold text-gray-700 dark:text-gray-300"
              >Mod√®le IA</label
            >
            <div class="space-y-2">
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': aiModel === 'gemini-3-flash-preview'}"
                ><input
                  type="radio"
                  value="gemini-3-flash-preview"
                  v-model="aiModel"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Flash (Rapide)
                  </div>
                </div></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': aiModel === 'gemini-2.5-pro'}"
                ><input type="radio" value="gemini-2.5-pro" v-model="aiModel" />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Pro (Intelligent)
                  </div>
                </div></label
              >
            </div>
            <label
              class="block text-sm font-bold text-gray-700 dark:text-gray-300 mt-4"
              >Cl√© API Gemini</label
            >
            <input
              v-model="apiKey"
              type="password"
              placeholder="Cl√© Google AI Studio..."
              class="w-full border dark:border-gray-600 dark:bg-gray-800 p-2 rounded text-sm"
            />
            <label
              class="block text-sm font-bold text-gray-700 dark:text-gray-300 mt-4"
              >Son de notification</label
            >
            <div class="space-y-2">
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'fanfare'}"
                ><input
                  type="radio"
                  value="fanfare"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Fanfare
                  </div>
                </div>
                <button
                  @click.stop="previewSound('fanfare')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'gandalf'}"
                ><input
                  type="radio"
                  value="gandalf"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Gandalf
                  </div>
                </div>
                <button
                  @click.stop="previewSound('gandalf')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label>
                <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'tennis'}"
                ><input
                  type="radio"
                  value="tennis"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Tennis
                  </div>
                </div>
                <button
                  @click.stop="previewSound('tennis')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label>

              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'kawoosh'}"
                ><input
                  type="radio"
                  value="kawoosh"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Kawoosh
                  </div>
                </div>
                <button
                  @click.stop="previewSound('kawoosh')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'zat'}"
                ><input type="radio" value="zat" v-model="notificationSound" />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">Zat</div>
                </div>
                <button
                  @click.stop="previewSound('zat')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'beep'}"
                ><input type="radio" value="beep" v-model="notificationSound" />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">Bip</div>
                </div>
                <button
                  @click.stop="previewSound('beep')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'college'}"
                ><input
                  type="radio"
                  value="college"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Coll√®ge
                  </div>
                </div>
                <button
                  @click.stop="previewSound('college')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'chat'}"
                ><input type="radio" value="chat" v-model="notificationSound" />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">Miaou</div>
                </div>
                <button
                  @click.stop="previewSound('chat')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'SNCF'}"
                ><input type="radio" value="SNCF" v-model="notificationSound" />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">SNCF</div>
                </div>
                <button
                  @click.stop="previewSound('SNCF')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'erreur'}"
                ><input
                  type="radio"
                  value="erreur"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Erreur XP
                  </div>
                </div>
                <button
                  @click.stop="previewSound('erreur')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'motus'}"
                ><input
                  type="radio"
                  value="motus"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">Motus</div>
                </div>
                <button
                  @click.stop="previewSound('motus')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'airhorn'}"
                ><input
                  type="radio"
                  value="airhorn"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Corne de brume
                  </div>
                </div>
                <button
                  @click.stop="previewSound('airhorn')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'heehee'}"
                ><input
                  type="radio"
                  value="heehee"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Hee hee
                  </div>
                </div>
                <button
                  @click.stop="previewSound('heehee')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
              <label
                class="flex items-center gap-3 p-2 border dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
                :class="{'border-blue-500 bg-blue-50 dark:bg-blue-900/20': notificationSound === 'romantique'}"
                ><input
                  type="radio"
                  value="romantique"
                  v-model="notificationSound"
                />
                <div class="flex-1">
                  <div class="font-bold text-sm dark:text-gray-200">
                    Romantique
                  </div>
                </div>
                <button
                  @click.stop="previewSound('romantique')"
                  class="text-blue-600 text-xs px-2 py-1 border rounded"
                >
                  Tester
                </button></label
              >
            </div>
          </div>
          <div class="p-4 border-t dark:border-darkborder flex justify-end">
            <button
              @click="saveSettings"
              class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold"
            >
              Enregistrer
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showAddModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-md overflow-hidden"
        >
          <div class="p-5 border-b dark:border-darkborder">
            <h3 class="font-bold text-gray-800 dark:text-white">
              Nouvel Acquis
            </h3>
          </div>
          <div class="p-6 space-y-4">
            <textarea
              v-model="newOutcome.description"
              rows="3"
              class="w-full border dark:border-gray-600 dark:bg-gray-800 rounded p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            ></textarea
            ><select
              v-model="newOutcome.level"
              class="w-full border dark:border-gray-600 dark:bg-gray-800 rounded p-2 text-sm"
            >
              <option value="Basic">Fondamental</option>
              <option value="Intermediate">Interm√©diaire</option>
              <option value="Advanced">Avanc√©</option>
              <option value="Highly advanced">Expert</option></select
            ><label
              class="flex items-center gap-2 text-gray-700 dark:text-gray-300"
              ><input type="checkbox" v-model="newOutcome.isAI" /><span
                class="text-sm"
                >Contenu IA</span
              ></label
            >
          </div>
          <div
            class="p-4 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-2 border-t dark:border-darkborder"
          >
            <button
              @click="showAddModal=false"
              class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-200 rounded"
            >
              Annuler</button
            ><button
              @click="addCustomOutcome"
              class="px-4 py-2 text-sm bg-blue-600 text-white rounded font-bold"
            >
              Ajouter
            </button>
          </div>
        </div>
      </div>
      <div
        v-if="showCommentModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showCommentModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-md h-[500px] flex flex-col relative"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center rounded-t-xl"
          >
            <h3
              class="font-bold text-sm text-gray-700 dark:text-gray-200 truncate pr-4"
            >
              Discussion: {{ currentView }}
            </h3>
            <button @click="showCommentModal=false" class="text-gray-400">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-3">
            <div
              v-if="getFilteredComments(currentOutcomeForComments).length === 0"
              class="text-center text-gray-400 text-xs italic mt-10"
            >
              Aucun commentaire pour {{ currentView }}.
            </div>
            <div
              v-for="(c, i) in getFilteredComments(currentOutcomeForComments)"
              :key="i"
              class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border dark:border-darkborder relative group"
            >
              <div class="flex justify-between items-center mb-1">
                <div>
                  <span
                    class="font-bold text-xs text-blue-600 dark:text-blue-400"
                    >{{ c.author }}</span
                  ><span
                    v-if="currentView === 'Overview' && c.year"
                    :class="['ml-2 text-[9px] px-1.5 py-0.5 rounded font-bold border', c.year==='L1'?'year-L1':(c.year==='L2'?'year-L2':'year-L3')]"
                    >{{ c.year }}</span
                  >
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-[10px] text-gray-400"
                    >{{ new Date(c.date).toLocaleDateString() }}</span
                  ><button
                    v-if="c.author === user.email.split('@')[0]"
                    @click="deleteComment(c)"
                    class="text-gray-400 hover:text-red-500 transition px-1"
                    title="Supprimer"
                  >
                    <i class="ph ph-trash text-sm"></i>
                  </button>
                </div>
              </div>
              <p class="text-sm text-gray-800 dark:text-gray-200">
                {{ c.text }}
              </p>
            </div>
          </div>
          <div class="p-3 border-t dark:border-darkborder flex gap-2">
            <input
              v-model="newCommentText"
              @keyup.enter="addComment"
              placeholder="Ajouter une note..."
              class="flex-1 border dark:border-gray-600 dark:bg-gray-800 rounded px-3 py-2 text-sm outline-none"
            /><button
              @click="addComment"
              class="text-blue-600 hover:bg-blue-50 dark:hover:bg-gray-700 p-2 rounded"
            >
              <i class="ph ph-paper-plane-right text-lg"></i>
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showImportModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showImportModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-md overflow-hidden"
        >
          <div
            class="p-5 border-b dark:border-darkborder flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600 text-white"
          >
            <h3 class="font-bold flex items-center gap-2">
              <i class="ph ph-magic-wand"></i> Import Magique
            </h3>
            <button @click="showImportModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600 dark:text-gray-300">
              Collez l'URL d'un plan de cours (page publique). L'IA va
              l'analyser et cocher automatiquement les comp√©tences
              correspondantes.
            </p>
            <input
              v-model="importUrl"
              type="url"
              placeholder="https://mon-universite.fr/cours/info101"
              class="w-full border dark:border-gray-600 dark:bg-gray-800 rounded p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none"
            />

            <div
              v-if="importLoading"
              class="flex flex-col items-center justify-center py-4 space-y-2 text-purple-600"
            >
              <i class="ph ph-spinner animate-spin text-3xl"></i>
              <span class="text-xs font-bold"
                >Analyse du syllabus en cours...</span
              >
            </div>

            <button
              v-else
              @click="fetchSyllabus"
              :disabled="!importUrl"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Lancer l'analyse
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showTimeMachineModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showTimeMachineModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-teal-600 text-white flex justify-between items-center"
          >
            <h3 class="font-bold flex items-center gap-2">
              <i class="ph ph-clock-counter-clockwise"></i> Time Machine
            </h3>
            <button @click="showTimeMachineModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>

          <div
            class="p-4 bg-gray-50 dark:bg-gray-800/50 border-b dark:border-darkborder"
          >
            <label class="block text-xs font-bold text-gray-500 mb-1"
              >CR√âER UNE SAUVEGARDE</label
            >
            <div class="flex gap-2">
              <input
                v-model="newSnapshotName"
                placeholder="Ex: Version Valid√©e 2024..."
                class="flex-1 border rounded px-3 py-2 text-sm outline-none dark:bg-gray-700 dark:border-gray-600"
              />
              <button
                @click="createSnapshot"
                :disabled="!newSnapshotName"
                class="bg-teal-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-teal-700 disabled:opacity-50"
              >
                Sauver
              </button>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto p-4 space-y-2">
            <div
              v-if="snapshots.length === 0"
              class="text-center text-gray-400 text-xs italic py-4"
            >
              Aucune sauvegarde trouv√©e.
            </div>
            <div
              v-for="snap in snapshots"
              :key="snap.id"
              class="flex justify-between items-center p-3 border rounded bg-white dark:bg-gray-700 dark:border-gray-600 group"
            >
              <div>
                <div class="font-bold text-sm text-gray-800 dark:text-gray-200">
                  {{ snap.name }}
                </div>
                <div class="text-[10px] text-gray-500 dark:text-gray-400">
                  {{ new Date(snap.date).toLocaleString() }} par {{
                  snap.user.split('@')[0] }}
                </div>
              </div>
              <button
                @click="restoreSnapshot(snap)"
                class="text-xs border border-teal-500 text-teal-600 px-2 py-1 rounded hover:bg-teal-50 dark:hover:bg-teal-900/30 transition"
              >
                Restaurer
              </button>
            </div>
          </div>
        </div>
      </div>

      <div v-if="showActivityPanel">
        <div
          class="fixed inset-0 bg-black/30 z-50"
          @click="showActivityPanel = false"
        ></div>

        <div
          class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-darkpanel shadow-2xl z-[60] flex flex-col transform transition-transform duration-300 animate-fade-in-right"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-gray-50 dark:bg-gray-800 flex justify-between items-center"
          >
            <h3 class="font-bold flex items-center gap-2">
              <i class="ph ph-activity text-orange-500"></i> Activit√© √âquipe
            </h3>
            <button
              @click="showActivityPanel = false"
              class="hover:bg-gray-200 p-1 rounded"
            >
              <i class="ph ph-x"></i>
            </button>
          </div>

          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div
              v-if="activities.length === 0"
              class="text-center text-gray-400 text-xs italic mt-10"
            >
              Aucune activit√© r√©cente.
            </div>

            <div
              v-for="act in activities"
              :key="act.id"
              class="flex gap-3 text-sm"
            >
              <div
                class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs flex-shrink-0 uppercase"
              >
                {{ act.user.substring(0,2) }}
              </div>
              <div>
                <p class="text-gray-800 dark:text-gray-200">
                  <span class="font-bold">{{ act.user }}</span>
                  {{ act.action }}
                  <span
                    class="font-medium text-indigo-600 bg-indigo-50 px-1 rounded"
                    >{{ act.detail }}</span
                  >
                </p>
                <p
                  class="text-[10px] text-gray-400 mt-0.5 flex items-center gap-1"
                >
                  <i class="ph ph-clock"></i> {{ new
                  Date(act.date).toLocaleString() }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        v-if="showEditResModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showEditResModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-md overflow-hidden"
        >
          <div
            class="p-4 border-b dark:border-darkborder bg-gray-50 dark:bg-gray-800/50 flex justify-between items-center"
          >
            <h3
              class="font-bold text-gray-800 dark:text-white flex items-center gap-2"
            >
              <i class="ph ph-pencil-simple text-blue-600"></i> Modifier la
              ressource
            </h3>
            <button @click="showEditResModal=false">
              <i class="ph ph-x text-lg text-gray-400"></i>
            </button>
          </div>

          <div class="p-6 space-y-4">
            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >Titre du document</label
              >
              <input
                v-model="editResForm.title"
                type="text"
                class="w-full border dark:border-gray-600 dark:bg-gray-800 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-500 mb-1"
                >URL (Lien)</label
              >
              <input
                v-model="editResForm.url"
                type="url"
                class="w-full border dark:border-gray-600 dark:bg-gray-800 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs text-blue-600"
              />
            </div>
          </div>

          <div
            class="p-4 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-2 border-t dark:border-darkborder"
          >
            <button
              @click="showEditResModal=false"
              class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded"
            >
              Annuler
            </button>
            <button
              @click="saveEditedResource"
              class="px-4 py-2 text-sm font-bold bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2"
            >
              <i class="ph ph-floppy-disk"></i> Enregistrer
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showImportConfirmModal"
        class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4"
        @click.self="showImportConfirmModal=false"
      >
        <div
          class="bg-white dark:bg-darkpanel rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh]"
        >
          <div
            class="p-4 border-b dark:border-darkborder flex justify-between items-center bg-purple-50 dark:bg-purple-900/20"
          >
            <div>
              <h3 class="font-bold text-purple-900 dark:text-purple-100">
                R√©sultats de l'analyse
              </h3>
              <p class="text-xs text-purple-600 dark:text-purple-300">
                Cochez les comp√©tences √† valider en
                <b>{{ currentView === 'Overview' ? 'L1' : currentView }}</b>
              </p>
            </div>
            <button @click="showImportConfirmModal=false">
              <i class="ph ph-x text-lg"></i>
            </button>
          </div>
          <div class="p-4 flex-1 overflow-y-auto space-y-2">
            <div
              v-if="importAnalysisResult.length === 0"
              class="text-center text-gray-500 py-8"
            >
              Aucune correspondance √©vidente trouv√©e par l'IA.
            </div>

            <div
              v-for="(item, idx) in importAnalysisResult"
              :key="idx"
              class="flex gap-3 p-3 border rounded-lg dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition cursor-pointer"
              @click="item.selected = !item.selected"
            >
              <div class="pt-1">
                <input
                  type="checkbox"
                  v-model="item.selected"
                  class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 cursor-pointer"
                />
              </div>
              <div>
                <div>
                  <div
                    class="font-bold text-sm text-gray-800 dark:text-white flex items-center gap-2"
                  >
                    {{ item.id }} - {{ getCompetenceName(item.id) }}
                    <span
                      class="bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 text-[9px] px-1.5 py-0.5 rounded font-mono uppercase"
                      >{{ item.level }}</span
                    >
                  </div>

                  <div
                    class="text-xs text-gray-600 dark:text-gray-300 mt-1 mb-1 p-2 bg-gray-100 dark:bg-gray-700/50 rounded border dark:border-gray-600"
                  >
                    {{ getOutcomeDescription(item.id) }}
                  </div>

                  <div
                    class="text-[10px] text-purple-600 dark:text-purple-300 italic flex gap-1"
                  >
                    <i class="ph ph-sparkle"></i> "{{ item.justification }}"
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="p-4 border-t dark:border-darkborder flex justify-end gap-2 bg-gray-50 dark:bg-gray-800/50"
          >
            <button
              @click="showImportConfirmModal=false"
              class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded"
            >
              Annuler
            </button>
            <button
              @click="applyImport"
              class="px-4 py-2 text-sm font-bold bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
            >
              <i class="ph ph-check-circle"></i> Confirmer & Appliquer
            </button>
          </div>
        </div>
      </div>

      <div
        class="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"
      >
        <transition-group name="toast">
          <div
            v-for="toast in toasts"
            :key="toast.id"
            class="pointer-events-auto flex items-center gap-3 px-4 py-3 rounded shadow-lg border transform transition-all duration-300 min-w-[250px]"
            :class="{
                        'bg-white dark:bg-gray-800 border-l-4 border-l-green-500 text-green-700 dark:text-green-400': toast.type === 'success',
                        'bg-white dark:bg-gray-800 border-l-4 border-l-red-500 text-red-700 dark:text-red-400': toast.type === 'error',
                        'bg-white dark:bg-gray-800 border-l-4 border-l-blue-500 text-blue-700 dark:text-blue-400': toast.type === 'info'
                     }"
          >
            <div class="text-xl">
              <i v-if="toast.type === 'success'" class="ph ph-check-circle"></i>
              <i v-if="toast.type === 'error'" class="ph ph-warning-circle"></i>
              <i v-if="toast.type === 'info'" class="ph ph-info"></i>
            </div>

            <div class="flex-1">
              <p class="text-xs font-bold">
                {{ toast.type === 'error' ? 'Erreur' : (toast.type === 'success'
                ? 'Succ√®s' : 'Info') }}
              </p>
              <p class="text-sm font-medium text-gray-700 dark:text-gray-200">
                {{ toast.message }}
              </p>
            </div>

            <button
              @click="removeToast(toast.id)"
              class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
            >
              <i class="ph ph-x"></i>
            </button>
          </div>
        </transition-group>
      </div>
    </div>

    <script type="module">
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

      const OFFICIAL_TITLES = {
        1.1: "Naviguer, rechercher et filtrer",
        1.2: "√âvaluer les donn√©es",
        1.3: "G√©rer les donn√©es",
        2.1: "Interagir via le num√©rique",
        2.2: "Partager",
        2.3: "Citoyennet√©",
        2.4: "Collaborer",
        2.5: "N√©tiquette",
        2.6: "Identit√© num√©rique",
        3.1: "D√©velopper contenu",
        3.2: "Int√©grer",
        3.3: "Droits d'auteur",
        3.4: "Programmation",
        4.1: "Prot√©ger √©quipements",
        4.2: "Prot√©ger donn√©es",
        4.3: "Prot√©ger sant√©",
        4.4: "Prot√©ger environnement",
        5.1: "R√©soudre probl√®mes",
        5.2: "Identifier besoins",
        5.3: "Cr√©ativit√©",
        5.4: "Lacunes",
      };
      const firebaseConfig = {
        apiKey: "AIzaSyA1u9I4OQsKlfwi9X-cFMQmCxelWyJcdw8",
        authDomain: "toccata-958f9.firebaseapp.com",
        databaseURL: "https://toccata-958f9.firebaseio.com",
        projectId: "toccata-958f9",
        storageBucket: "toccata-958f9.firebasestorage.app",
        messagingSenderId: "867467991937",
        appId: "1:867467991937:web:a084bd4f07bdf49f386680",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          // 1. Logique Time Machine
          const showTimeMachineModal = ref(false);
          const snapshots = ref([]);
          const newSnapshotName = ref("");

          const loadSnapshots = async () => {
            const snap = await db
              .collection("snapshots")
              .orderBy("date", "desc")
              .limit(20)
              .get();
            snapshots.value = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          };

          // --- CHASSEUR DE RESSOURCES (AI + IMAGES) ---
          const showHunterModal = ref(false);
          const hunterLoading = ref(false);
          const hunterResults = ref(null); // Stocke les propositions (Videos, Docs, Images)

          const openResourceHunter = (outcome) => {
            currentOutcomeForAI.value = outcome; // On r√©utilise cette variable existante
            hunterResults.value = null;
            showHunterModal.value = true;
          };

          // --- CHASSEUR DE RESSOURCES : MODE ASSISTANT (Stable) ---

          const hunterSearchTerms = ref(null); // Stocke les strat√©gies de recherche
          const magicUrlInput = ref(""); // Champ de collage URL
          const magicLoading = ref(false);

          const launchHunter = async () => {
            if (!apiKey.value) {
              alert("Cl√© API Gemini requise.");
              return;
            }

            hunterLoading.value = true;
            hunterResults.value = null; // On vide les r√©sultats pr√©c√©dents
            hunterSearchTerms.value = null; // On vide les boutons pr√©c√©dents

            try {
              const genAI = new GoogleGenerativeAI(apiKey.value);
              // On n'utilise PAS d'outils complexes, juste le mod√®le standard rapide
              const model = genAI.getGenerativeModel({
                model: "gemini-3-flash-preview",
                generationConfig: { responseMimeType: "application/json" }, // On force le JSON
              });

              const context = currentOutcomeForAI.value.description;

              // On demande √† l'IA de pr√©parer le terrain (Les requ√™tes id√©ales)
              const prompt = `Agis comme un expert p√©dagogique.
                        Sujet : "${context}" (Niveau ${currentOutcomeForAI.value.level}).

                        Ta mission : Cr√©er les meilleures requ√™tes de recherche pour trouver des ressources de qualit√©.

                        R√©ponds avec ce JSON :
                        {
                            "yt_query": "La phrase exacte √† taper dans YouTube pour trouver un bon tuto",
                            "google_query": "La phrase exacte √† taper dans Google pour trouver un article de fond",
                            "wiki_query": "Le concept cl√© exact pour Wikipedia"
                        }`;

              const result = await model.generateContent(prompt);
              const text = result.response.text();
              hunterSearchTerms.value = JSON.parse(text);

              // BONUS : On tente quand m√™me Wikipedia en auto (car l'API est ouverte et stable)
              try {
                const wikiUrl = `https://fr.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(
                  hunterSearchTerms.value.wiki_query
                )}&limit=2&format=json&origin=*`;
                const wResp = await fetch(wikiUrl);
                if (wResp.ok) {
                  const wJson = await wResp.json(); // Format [query, [titres], [desc], [urls]]
                  if (wJson[1].length > 0) {
                    // On initialise hunterResults avec les suggestions Wiki
                    hunterResults.value = {
                      suggestions: wJson[1].map((t, i) => ({
                        title: "üìñ " + t,
                        url: wJson[3][i],
                        thumbnail: null,
                        isAuto: true,
                        snippet: wJson[2][i],
                      })),
                    };
                  }
                }
              } catch (e) {
                console.warn("Wiki auto a √©chou√©, pas grave", e);
              }
            } catch (e) {
              console.error(e);
              showToast("Erreur IA : " + e.message, "error");
            } finally {
              hunterLoading.value = false;
            }
          };

          // FONCTION MAGIQUE : Transforme une URL coll√©e en ressource riche
          // Helper pour raccourcir les URLs (Affichage propre)
          const shortUrl = (url) => {
            if (!url) return "";
            try {
              const u = new URL(url);
              // Affiche "www.google.com/..." au lieu de l'URL g√©ante
              return (
                u.hostname +
                (u.pathname.length > 1 || u.search.length > 1 ? "/..." : "")
              );
            } catch (e) {
              // Fallback si ce n'est pas une URL valide
              return url.length > 30 ? url.substring(0, 30) + "..." : url;
            }
          };

          // VERSION CORRIG√âE : Force la mise √† jour de la liste
          const fetchSmartTitle = async (url) => {
            // 1. Essai via NoEmbed (Pour YouTube, Vimeo, Twitter...)
            try {
              const oembed = await fetch(
                `https://noembed.com/embed?url=${encodeURIComponent(url)}`
              ).then((r) => r.json());
              if (oembed.title)
                return { title: oembed.title, thumb: oembed.thumbnail_url };
            } catch (e) {}

            // 2. Essai via Proxy HTML (Pour les sites de doc, blogs, articles)
            try {
              const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(
                url
              )}`;
              const response = await fetch(proxyUrl);
              const data = await response.json();

              if (data.contents) {
                // On parse le HTML r√©cup√©r√© pour trouver la balise <title>
                const match = data.contents.match(/<title>(.*?)<\/title>/i);
                if (match && match[1]) {
                  // On nettoie le titre (enl√®ve les entit√©s HTML &amp;)
                  const cleanTitle = new DOMParser().parseFromString(
                    match[1],
                    "text/html"
                  ).body.textContent;
                  return { title: cleanTitle.trim(), thumb: null };
                }
              }
            } catch (e) {
              console.warn("Echec r√©cup√©ration titre", e);
            }

            return { title: "Ressource Web", thumb: null };
          };

          const handleMagicPaste = async () => {
            const url = magicUrlInput.value.trim();
            if (!url) return;

            magicLoading.value = true;

            try {
              // On utilise notre nouvelle fonction intelligente
              const metadata = await fetchSmartTitle(url);

              const newRes = {
                title: metadata.title,
                url: url,
                thumbnail: metadata.thumb,
                isAuto: false,
                user: "Moi",
                // ID unique indispensable pour que Vue accepte d'en ajouter plusieurs
                id: Date.now() + Math.random().toString(36).substr(2, 9),
              };

              if (!hunterResults.value)
                hunterResults.value = { suggestions: [] };

              // Ajout en haut de liste
              hunterResults.value.suggestions = [
                newRes,
                ...(hunterResults.value.suggestions || []),
              ];

              showToast("Lien analys√© : " + metadata.title, "success");
              magicUrlInput.value = "";
            } catch (e) {
              console.error(e);
              showToast("Erreur analyse lien", "error");
            } finally {
              magicLoading.value = false;
            }
          };

          const adoptResource = (res) => {
            if (!currentCompetence.value) return;

            // 1. Retrouver le LO cible (Version "Base de donn√©es")
            // On cherche dans la vraie structure de donn√©es, pas dans la copie locale
            let targetOutcome = null;
            const domain = digCompData.domains.find((d) =>
              d.competences.some((c) =>
                c.outcomes.some((o) => {
                  if (o.id === currentOutcomeForAI.value.id) {
                    // On utilise l'ID stock√© lors de l'ouverture de la modale
                    targetOutcome = o;
                    return true;
                  }
                  return false;
                })
              )
            );

            if (targetOutcome) {
              // 2. Initialiser le tableau s'il n'existe pas pour l'ann√©e en cours
              // Par d√©faut on ajoute √† l'ann√©e courante ou 'L3' si ind√©fini
              const year =
                currentView.value === "Overview"
                  ? "L3"
                  : currentView.value === "Kanban"
                  ? kanbanYear.value
                  : currentView.value;

              if (!targetOutcome.mappings[year]) {
                targetOutcome.mappings[year] = {
                  status: "none",
                  resources: [],
                };
              }
              if (!targetOutcome.mappings[year].resources) {
                targetOutcome.mappings[year].resources = [];
              }

              // 3. CR√âER UNE COPIE PROPRE (Crucial !)
              // Si on pousse 'res' directement, on pousse la r√©f√©rence de la modale.
              // Il faut cloner l'objet.
              const resourceToAdd = {
                title: res.title || "Nouvelle ressource",
                url: res.url,
                type: res.url.includes("youtu") ? "video" : "web",
                addedAt: new Date().toISOString(),
              };

              // 4. Ajout et Notification
              targetOutcome.mappings[year].resources.push(resourceToAdd);

              logActivity("a ajout√© une ressource", targetOutcome.id);
              showToast("Ressource ajout√©e au cours !", "success");

              // Force le rafra√Æchissement de l'interface principale
              triggerUpdate();
            } else {
              showToast(
                "Erreur : Impossible de retrouver le LO cible",
                "error"
              );
            }
          };

          // --- GESTION AM√âLIOR√âE DU CHAT (FICHIERS + COLLER) ---

                const fileInput = ref(null);

                const triggerFileInput = () => fileInput.value.click();

                // 1. Fonction centrale d'envoi de fichier (Base64)
                const sendAttachment = (file) => {
                    if (!file) return;

                    // Limite Firestore (1 Mo pour √©viter les erreurs)
                    if (file.size > 1485760) {
                        showToast("Fichier trop volumineux (Max 1 Mo)", "error");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64String = e.target.result;
                        const type = file.type.startsWith('image/') ? 'image' : 'file';

                        await db.collection('messages').add({
                            text: '',
                            attachment: base64String,
                            attachmentName: file.name,
                            attachmentType: type,
                            sender: user.value.email,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        nextTick(() => { if(chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight; });
                    };
                    reader.readAsDataURL(file);
                };

                // 2. Gestion du bouton Upload (Trombone)
                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    sendAttachment(file);
                    event.target.value = ''; // Reset
                };

                // 3. Gestion du "Coller" (CTRL+V) dans la zone de texte
                const handlePaste = (event) => {
                    const items = (event.clipboardData || event.originalEvent.clipboardData).items;

                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file') {
                            const blob = item.getAsFile();
                            // Si c'est une image, on l'envoie direct
                            if (blob) {
                                sendAttachment(blob);
                                event.preventDefault(); // Emp√™che de coller le nom du fichier en texte
                                showToast("Image coll√©e et envoy√©e !", "success");
                            }
                        }
                    }
                };

                // 3. Rendre les liens cliquables (Regex)
                const formatMessage = (text) => {
                    if (!text) return '';
                    // Regex pour trouver les URLs
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return text.replace(urlRegex, (url) => {
                        return `<a href="${url}" target="_blank" class="text-blue-500 underline break-all">${url}</a>`;
                    });
                };

                // 4. Nettoyage automatique (> 30 Jours)
                const cleanupOldMessages = async () => {
                    // Date d'il y a 30 jours
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const snapshot = await db.collection('messages')
                        .where('timestamp', '<', thirtyDaysAgo)
                        .get();

                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        console.log(`${snapshot.size} anciens messages supprim√©s.`);
                    }
                };

          // --- DIFF VISUEL ---
                
                // 1. Fonction qui g√©n√®re le HTML color√©
                const getDiffHtml = (oldText, newText) => {
                    if (!oldText && !newText) return '';
                    // On utilise la librairie globale "Diff" charg√©e dans le head
                    const diff = Diff.diffWords(oldText || '', newText || '');
                    
                    return diff.map(part => {
                        // Vert pour ajout, Rouge barr√© pour suppression, Gris pour inchang√©
                        const color = part.added ? 'bg-green-200 text-green-800 font-bold px-1 rounded' :
                                      part.removed ? 'bg-red-100 text-red-800 line-through px-1 rounded opacity-70' : 
                                      'text-gray-600 dark:text-gray-300';
                        return `<span class="${color}">${part.value}</span>`;
                    }).join('');
                };

                // 2. Variable pour l'√©dition de description
                const editingOutcomeId = ref(null);
                const tempDescription = ref('');

                // 3. Activer le mode √©dition
                const startEditDescription = (outcome) => {
                    editingOutcomeId.value = outcome.id;
                    tempDescription.value = outcome.description;
                };

                // 4. Sauvegarder et CR√âER LE LOG pour le diff
                const saveDescription = (outcome) => {
                    if (tempDescription.value !== outcome.description) {
                        const oldDesc = outcome.description;
                        const newDesc = tempDescription.value;
                        
                        outcome.description = newDesc; // Mise √† jour locale
                        
                        // IMPORTANT : On loggue l'ancienne et la nouvelle valeur compl√®te
                        logAction('desc_edit', outcome.id, 'Modification description', currentView.value, oldDesc, newDesc);
                        
                        triggerUpdate(); // Sauvegarde Firebase
                        showToast("Description mise √† jour", "success");
                    }
                    editingOutcomeId.value = null;
                };

          const createSnapshot = async () => {
            if (!newSnapshotName.value.trim()) return;
            await db.collection("snapshots").add({
              name: newSnapshotName.value,
              user: user.value.email,
              date: new Date().toISOString(),
              data: JSON.parse(JSON.stringify(digCompData.domains)), // Copie profonde de l'√©tat actuel
            });
            newSnapshotName.value = "";
            await loadSnapshots();
            showToast("Sauvegarde r√©ussie", "success");
          };

          const restoreSnapshot = async (snap) => {
            if (
              !confirm(
                `‚ö†Ô∏è ATTENTION : Vous allez √©craser la maquette actuelle par la version "${snap.name}".\n\n√ätes-vous s√ªr ?`
              )
            )
              return;
            digCompData.domains = snap.data;
            triggerUpdate(); // Sauvegarde imm√©diate dans la base principale
            showTimeMachineModal.value = false;
            showToast("Version restaur√©e avec succ√®s !", "success");
          };

          const activeLocks = ref({}); // Liste des verrous actuels

          // √âcoute des verrous en temps r√©el
          db.collection("locks").onSnapshot((snap) => {
            const locks = {};
            const now = Date.now();
            snap.forEach((doc) => {
              const data = doc.data();
              // Si le verrou a moins de 5 min, on le garde
              if (now - data.timestamp < 300000) {
                locks[doc.id] = data.user;
              }
            });
            activeLocks.value = locks;
          });

          const requestLock = (outcomeId) => {
            // On pose un verrou dans la base
            db.collection("locks")
              .doc(outcomeId)
              .set({
                user: user.value.email.split("@")[0],
                timestamp: Date.now(),
              });
          };

          const isLocked = (outcomeId) => {
            const locker = activeLocks.value[outcomeId];
            // Vrai si verrouill√© par quelqu'un d'autre que moi
            return locker && locker !== user.value.email.split("@")[0];
          };

          const getLockerName = (outcomeId) => activeLocks.value[outcomeId];

          const kanbanYear = ref("L1"); // Ann√©e par d√©faut du Kanban
          const draggedOutcome = ref(null);

          // Calcule les colonnes du Kanban (G√®re maintenant le mode Overview)
          const kanbanColumns = computed(() => {
            const cols = {
              none: { title: "√Ä faire", list: [], color: "border-red-400" },
              draft: {
                title: "En cours",
                list: [],
                color: "border-orange-400",
              },
              review: {
                title: "En relecture",
                list: [],
                color: "border-yellow-500",
              }, // Votre nouveau statut
              validated: {
                title: "Valid√©",
                list: [],
                color: "border-green-500",
              },
              obsolete: {
                title: "Obsol√®te",
                list: [],
                color: "border-gray-300",
              },
            };

            // D√©termine quelles ann√©es on affiche
            const yearsProcess =
              kanbanYear.value === "Overview"
                ? ["L1", "L2", "L3"]
                : [kanbanYear.value];

            digCompData.domains.forEach((d) => {
              d.competences.forEach((c) => {
                c.outcomes.forEach((o) => {
                  // 1. Filtre Mes T√¢ches
                  if (onlyMyTasks.value && user.value) {
                    const me = user.value.email.split("@")[0];
                    if (!o.assignees || !o.assignees.includes(me)) return;
                  }

                  // 2. Boucle sur les ann√©es concern√©es
                  yearsProcess.forEach((year) => {
                    const status =
                      o.mappings && o.mappings[year]
                        ? o.mappings[year].status
                        : "none";

                    if (cols[status]) {
                      // On cr√©e une carte pour CHAQUE ann√©e active
                      // On ajoute 'displayYear' pour savoir de quelle ann√©e il s'agit sur la carte
                      const item = {
                        ...o,
                        domainName: d.name,
                        compName: c.name,
                        displayYear: year, // Important pour l'affichage
                      };
                      cols[status].list.push(item);
                    }
                  });
                });
              });
            });
            return cols;
          });

          // Statistiques globales (Adapt√© pour Overview)
          const kanbanOverview = computed(() => {
            const stats = { L1: 0, L2: 0, L3: 0, total: 0 };

            // Si Overview, on compte tout, sinon juste l'ann√©e en cours
            const yearsToCheck =
              kanbanYear.value === "Overview"
                ? ["L1", "L2", "L3"]
                : [kanbanYear.value];

            digCompData.domains.forEach((d) => {
              d.competences.forEach((c) => {
                c.outcomes.forEach((o) => {
                  yearsToCheck.forEach((y) => {
                    const status =
                      o.mappings && o.mappings[y]
                        ? o.mappings[y].status
                        : "none";
                    if (status === "validated") {
                      if (stats[y] !== undefined) stats[y]++;
                      stats.total++;
                    }
                  });
                });
              });
            });
            return stats;
          });

          // Fonction pour assigner depuis le Kanban (qui utilise des copies d'objets)
          const toggleAssignmentById = (itemId) => {
            // On cherche l'original dans la base de donn√©es locale
            let found = null;
            for (const d of digCompData.domains) {
              for (const c of d.competences) {
                found = c.outcomes.find((o) => o.id === itemId);
                if (found) break;
              }
              if (found) break;
            }

            // Si trouv√©, on utilise la fonction standard de toggle
            if (found) toggleAssignment(found);
          };

          const onDrop = (status) => {
            if (draggedOutcome.value) {
              updateStatus(draggedOutcome.value, kanbanYear.value, status);
              draggedOutcome.value = null;
            }
          };

          const showSunburstModal = ref(false);

          const openSunburst = () => {
            showSunburstModal.value = true;
            nextTick(() => {
              const data = [
                {
                  type: "sunburst",
                  labels: [],
                  parents: [],
                  values: [],
                  outsidetextfont: { size: 20, color: "#377eb8" },
                  leaf: { opacity: 0.4 },
                  marker: { line: { width: 2 } },
                },
              ];

              // 1. Racine
              data[0].labels.push("DigComp");
              data[0].parents.push("");
              data[0].values.push(0);

              // 2. Domaines & Comp√©tences
              digCompData.domains.forEach((d) => {
                data[0].labels.push(d.name);
                data[0].parents.push("DigComp");
                data[0].values.push(0); // Sera calcul√© par Plotly

                d.competences.forEach((c) => {
                  data[0].labels.push(c.name);
                  data[0].parents.push(d.name);
                  let score = 0;
                  c.outcomes.forEach((o) => {
                    if (isCoveredAnywhere(o)) score++;
                  });
                  data[0].values.push(score || 1); // Taille = nombre de LO valid√©s
                });
              });

              Plotly.newPlot("sunburstChart", data, {
                margin: { l: 0, r: 0, b: 0, t: 0 },
              });
            });
          };

          // --- SYSTEME DE NOTIFICATION (TOASTS) ---
          const toasts = ref([]);
          let toastIdCounter = 0;

          const showToast = (message, type = "info") => {
            const id = toastIdCounter++;
            // Types possibles : 'success' (vert), 'error' (rouge), 'info' (bleu)
            toasts.value.push({ id, message, type });

            // Auto-suppression apr√®s 3 secondes
            setTimeout(() => {
              removeToast(id);
            }, 3000);
          };

          const removeToast = (id) => {
            toasts.value = toasts.value.filter((t) => t.id !== id);
          };

          // --- √âDITION DE RESSOURCE ---
          const showEditResModal = ref(false);
          const editResForm = reactive({
            title: "",
            url: "",
            outcome: null,
            year: "",
            original: null,
          });

          // Ouvre la modale et pr√©-remplit les champs
          const openEditResource = (outcome, res) => {
            editResForm.title = res.title;
            editResForm.url = res.url;
            editResForm.outcome = outcome;
            editResForm.year = res.year; // L'ann√©e est fournie par getAllResources
            editResForm.original = res; // On garde une r√©f√©rence pour retrouver l'original
            showEditResModal.value = true;
          };

          // Sauvegarde les modifications
          const saveEditedResource = () => {
            if (!editResForm.outcome || !editResForm.original) return;

            const mapping = editResForm.outcome.mappings[editResForm.year];

            if (mapping && mapping.resources) {
              // On cherche la ressource originale dans la liste (par ID si dispo, sinon par URL/Titre)
              const index = mapping.resources.findIndex(
                (r) =>
                  (r.id &&
                    editResForm.original.id &&
                    r.id === editResForm.original.id) ||
                  (r.url === editResForm.original.url &&
                    r.title === editResForm.original.title)
              );

              if (index !== -1) {
                // Mise √† jour des champs
                mapping.resources[index].title = editResForm.title;
                mapping.resources[index].url = editResForm.url;

                triggerUpdate(); // Sauvegarde en base
                showToast("Ressource modifi√©e avec succ√®s", "success");
                showEditResModal.value = false;

                // Petit log d'activit√©
                logActivity("a modifi√© une ressource", editResForm.title);
              } else {
                showToast(
                  "Erreur : Impossible de retrouver la ressource originale",
                  "error"
                );
              }
            }
          };

          // --- SUPPRESSION RESSOURCE ---
          const removeResource = (outcome, resObj) => {
            if (!confirm("Supprimer cette ressource d√©finitivement ?")) return;

            // 1. On identifie l'ann√©e concern√©e (L1, L2 ou L3) gr√¢ce √† votre objet res
            const year = resObj.year;

            // 2. On r√©cup√®re la liste r√©elle dans les donn√©es
            const mapping = outcome.mappings[year];

            if (mapping && mapping.resources) {
              // 3. On cherche l'index de la ressource (par url et titre pour √™tre s√ªr)
              const index = mapping.resources.findIndex(
                (r) => r.url === resObj.url && r.title === resObj.title
              );

              if (index !== -1) {
                mapping.resources.splice(index, 1); // Suppression
                triggerUpdate(); // Sauvegarde
                showToast("Ressource supprim√©e avec succ√®s", "success"); // Notification Toast
                logActivity("a supprim√© la ressource", deletedTitle);
              } else {
                showToast("Erreur : Ressource introuvable", "error");
              }
            }
          };

          const DIGCOMP_TO_PIX_MAP = {
            1.1: {
              code: "1.1",
              label: "Mener une recherche et une veille d‚Äôinformation",
            },
            1.2: { code: "1.2", label: "G√©rer des donn√©es" },
            1.3: { code: "1.3", label: "Traiter des donn√©es" },
            2.1: { code: "2.1", label: "Interagir" },
            2.2: { code: "2.2", label: "Partager et publier" },
            2.3: { code: "2.3", label: "Collaborer" },
            2.4: { code: "2.3", label: "Collaborer" }, // DigComp 2.4 -> Pix 2.3 (souvent fusionn√©)
            2.5: { code: "2.4", label: "S‚Äôins√©rer dans le monde num√©rique" },
            2.6: { code: "2.4", label: "S‚Äôins√©rer dans le monde num√©rique" }, // Identit√© num.
            3.1: { code: "3.1", label: "D√©velopper des documents textuels" },
            3.2: { code: "3.2", label: "D√©velopper des documents multim√©dia" },
            3.3: {
              code: "3.3",
              label: "Adapter les documents √† leur finalit√©",
            },
            3.4: { code: "3.4", label: "Programmer" },
            4.1: { code: "4.1", label: "S√©curiser l‚Äôenvironnement num√©rique" },
            4.2: {
              code: "4.2",
              label: "Prot√©ger les donn√©es personnelles et la vie priv√©e",
            },
            4.3: {
              code: "4.3",
              label: "Prot√©ger la sant√©, le bien-√™tre et l'environnement",
            },
            4.4: { code: "4.3", label: "Prot√©ger la sant√©..." }, // Souvent fusionn√©
            5.1: { code: "5.1", label: "R√©soudre des probl√®mes techniques" },
            5.2: {
              code: "5.2",
              label: "Construire un environnement num√©rique",
            }, // Identification besoins
            5.3: {
              code: "5.2",
              label: "Construire un environnement num√©rique",
            }, // Cr√©ativit√©
          };

          // 2. Conversion des niveaux (DigComp Global -> PIX Score Cible)
          const getPixTargetLevel = (digCompLevel) => {
            switch (digCompLevel) {
              case "Basic":
                return 2; // Novice (1-2)
              case "Intermediate":
                return 4; // Ind√©pendant (3-4)
              case "Advanced":
                return 6; // Avanc√© (5-6)
              case "Highly advanced":
                return 7; // Expert (7-8)
              default:
                return 1;
            }
          };

          // 3. Fonction d'Export
          const exportToPixExcel = () => {
            const rows = [];
            // AJOUT des en-t√™tes "Tags" et "Lien Preuve"
            rows.push([
              "Domaine PIX",
              "Comp√©tence PIX",
              "Niveau Cible",
              "Code DigComp",
              "Description",
              "Tags Composantes",
              "Lien Preuve",
            ]);

            digCompData.domains.forEach((d) => {
              d.competences.forEach((c) => {
                const shortId = c.id.split("/").pop();
                const pixEquiv = DIGCOMP_TO_PIX_MAP[shortId];

                if (pixEquiv) {
                  c.outcomes.forEach((o) => {
                    const targetYear =
                      currentView.value === "Overview"
                        ? "L3"
                        : currentView.value;

                    if (isStatusActive(o, targetYear)) {
                      rows.push([
                        pixEquiv.code.charAt(0),
                        `${pixEquiv.code} - ${pixEquiv.label}`,
                        getPixTargetLevel(o.level),
                        shortId,
                        o.description,
                        // AJOUT DES DONN√âES ICI
                        (o.tags || []).join(", "), // Les tags
                        o.mappings[targetYear].courseLink || "", // Le lien du cours
                      ]);
                    }
                  });
                }
              });
            });

            if (rows.length <= 1) {
              showToast("Aucune donn√©e √† exporter !", "warning");
              return;
            }
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Export_PIX");
            XLSX.writeFile(wb, `export_pix_${currentView.value}.xlsx`);
            showToast("Export g√©n√©r√© avec succ√®s !", "success");
          };

          // 2. Logique Export Moodle
          const exportMoodleXML = async () => {
            if (!aiResult.value) return;
            // On garde le contenu actuel en m√©moire pour ne pas le perdre
            const originalContent = aiResult.value;
            aiLoading.value = true;

            try {
              const model = new GoogleGenerativeAI(
                apiKey.value
              ).getGenerativeModel({ model: aiModel.value });
              const prompt = `Agis comme un expert LMS. Convertis le QCM ci-dessous au format "Moodle XML" strict.
                        Le code XML doit √™tre valide et pr√™t √† l'import.
                        Ne mets AUCUN texte avant ou apr√®s le code XML (pas de markdown).

                        CONTENU √Ä CONVERTIR :
                        ${originalContent}`;

              const result = await model.generateContent(prompt);
              const xmlContent = (await result.response)
                .text()
                .replace(/```xml/g, "")
                .replace(/```/g, "")
                .trim();

              // T√©l√©chargement du fichier
              const blob = new Blob([xmlContent], { type: "text/xml" });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `qcm_moodle_${Date.now()}.xml`;
              a.click();

              // On remet le contenu original (pour que l'utilisateur puisse continuer √† lire)
              aiResult.value = originalContent;
            } catch (e) {
              aiError.value = "Erreur conversion : " + e.message;
            } finally {
              aiLoading.value = false;
            }
          };

          const digCompData = reactive({ domains: [] });
          const currentCompetence = ref(null);
          const currentFilter = ref("All");
          const searchQuery = ref("");
          const currentView = ref("L1");
          const isMobileMenuOpen = ref(false);
          const isDarkMode = ref(false);
          const showCheckedOnly = ref(false);
          const selectedComponentTag = ref("");

          const user = ref(null);
          const connectedUsers = ref([]);
          const authForm = reactive({ email: "", password: "" });
          const authError = ref("");
          const loading = ref(false);
          const isSyncing = ref(false);

          const showChat = ref(false);
          const showEmojiPicker = ref(false);
          const showSettingsModal = ref(false);
          const showCommentModal = ref(false);
          const showHistoryModal = ref(false);
          const showLOHistoryModal = ref(false);
          const showAIModal = ref(false);
          const showNotifDropdown = ref(false);
          const notificationSound = ref("fanfare");
          const apiKey = ref("");
          const aiModel = ref("gemini-3-flash-preview");
          const availableTags = ref([
            "ASSP",
            "FJVD",
            "LANG",
            "LESLA",
            "SEG",
            "TT",
            "ICOM",
            "IETL",
            "IFS",
            "IPsyL",
            "ISPEF",
            "IUT",
            "CIEF",
          ]);

          const componentDetails = {
            ASSP: "Anthropologie, sociologie et science politique",
            FJVD: "Facult√© de Droit Julie-Victoire Daubi√©",
            LANG: "Langues",
            LESLA: "Lettres, sciences du langage et arts",
            SEG: "Sciences √©conomiques et gestion",
            TT: "Temps et territoires",
            ICOM: "Institut de la communication",
            IETL: "Institut d √©tudes du travail de Lyon",
            IFS: "Institut de formation syndicale",
            IPsyL: "Institut de Psychologie de Lyon",
            ISPEF:
              "Institut des sciences et pratiques de l √©ducation et de formation",
            IUT: "",
            CIEF: "Centre international d √©tudes fran√ßaises",
          };

          // Fonction helper pour l'affichage
          const getLongName = (tag) => componentDetails[tag] || "";

          const chatMessages = ref([]);
          const newMessage = ref("");
          const newCommentText = ref("");
          const chatBox = ref(null);
          const unreadCount = ref(0);
          const showAddModal = ref(false);
          const newOutcome = reactive({
            description: "",
            level: "Intermediate",
            isAI: false,
          });
          const notifPermission = ref(Notification.permission);
          const lastReadTime = ref(new Date(0));
          const appStartTime = new Date();
          const currentOutcomeForComments = ref(null);
          const currentOutcomeForAI = ref(null);
          const currentAIType = ref("");
          const currentHistoryOutcomeTitle = ref("");
          const currentLOHistory = ref([]);
          const aiResult = ref("");
          const aiLoading = ref(false);
          const aiError = ref("");
          const pinnedCompetences = ref([]);
          const historyLogs = ref([]);
          const userNotifications = ref([]);

          const showImportModal = ref(false);
          const showImportConfirmModal = ref(false);
          const importUrl = ref("");
          const importLoading = ref(false);
          const importAnalysisResult = ref([]);

          let typingTimeout = null,
            heartbeatInterval = null,
            idleTimeout = null,
            radarChartInstance = null;
          let dashBarChart = null,
            dashDoughnutChart = null,
            dashRadarChart = null;

          const visioState = reactive({
            isOpen: false, // Fen√™tre visible ?
            isActive: false, // Appel en cours ?
            minimized: false, // R√©duit ?
            x: 100,
            y: 100, // Position
            dragging: false,
            relX: 0,
            relY: 0,
            api: null, // Instance Jitsi
          });

          const toggleVisio = () => {
            // 1. Si pas d'appel, on lance
            if (!visioState.isActive) {
              visioState.isOpen = true;
              visioState.isActive = true;
              nextTick(initJitsi);
            }
            // 2. Si appel en cours mais fen√™tre cach√©e (minimis√©e), on la remet
            else if (!visioState.isOpen) {
              visioState.isOpen = true;
            }
            // 3. Si fen√™tre ouverte, on la cache (minimise) sans couper
            else {
              visioState.isOpen = false;
            }
          };

          const initJitsi = () => {
            if (visioState.api) return;

            const domain = "8x8.vc";
            const appID = "vpaas-magic-cookie-6d9b644a44dd43169d30c23ee93d243e"; // VOTRE APP ID

            const options = {
              roomName: `${appID}/DigComp_Salle_Virtuelle`, // Nom de salle unique
              width: "100%",
              height: "100%",
              parentNode: document.querySelector("#jaas-container"),
              configOverwrite: {
                startWithAudioMuted: true,
                startWithVideoMuted: true,
              },
              userInfo: {
                displayName: user.value
                  ? user.value.email.split("@")[0]
                  : "Invit√©",
              },
            };

            visioState.api = new window.JitsiMeetExternalAPI(domain, options);

            // Nettoyage quand on quitte
            visioState.api.addEventListeners({
              videoConferenceLeft: () => {
                visioState.api.dispose();
                visioState.api = null;
                visioState.isActive = false;
                visioState.isOpen = false;
              },
            });
          };

          // --- RESOURCE INSIGHT (ANALYSEUR DE CONTENU) ---
                const analyzingResId = ref(null); // Pour afficher le spinner sur la bonne ressource

                const analyzeResourceContent = async (outcome, resWrapper) => {
                    if (!apiKey.value) { alert("Cl√© API requise"); return; }

                    // 1. On retrouve la ressource originale dans la structure de donn√©es
                    // (car resWrapper est une copie avec l'ann√©e ajout√©e)
                    const mapping = outcome.mappings[resWrapper.year];
                    if (!mapping || !mapping.resources) return;

                    const originalRes = mapping.resources.find(r => r.url === resWrapper.url && r.title === resWrapper.title);
                    if (!originalRes) return;

                    analyzingResId.value = resWrapper.url; // D√©but chargement

                    try {
                        // 2. R√©cup√©ration du contenu (Scraping l√©ger via Proxy)
                        let contentText = "";

                        // Si c'est YouTube, on ne peut pas scraper le transcript facilement sans API complexe.
                        // On se base sur le titre et l'URL pour que l'IA "devine" ou utilise ses connaissances.
                        if (originalRes.url.includes('youtube') || originalRes.url.includes('youtu.be')) {
                            contentText = `Vid√©o YouTube intitul√©e : "${originalRes.title}". URL: ${originalRes.url}`;
                        } else {
                            // Pour les pages web classiques
                            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(originalRes.url)}`;
                            const response = await fetch(proxyUrl);
                            const data = await response.json();
                            if (data.contents) {
                                // On nettoie le HTML pour ne garder que le texte
                                const doc = new DOMParser().parseFromString(data.contents, "text/html");
                                contentText = doc.body.innerText.replace(/\s+/g, ' ').substring(0, 10000); // Max 10k chars
                            }
                        }

                        if (!contentText) throw new Error("Impossible de lire le contenu");

                        // 3. Appel IA
                        const model = new GoogleGenerativeAI(apiKey.value).getGenerativeModel({model: aiModel.value});
                        const prompt = `Analyse cette ressource p√©dagogique.
                        Contexte : "${contentText}".

                        G√©n√®re un JSON strict avec :
                        - "time": estimation temps lecture/visionnage (ex: "5 min").
                        - "tags": tableau de 3 mots-cl√©s pertinents (courts).
                        - "summary": un r√©sum√© tr√®s concis en 2 phrases maximum (fran√ßais).

                        R√©ponds UNIQUEMENT le JSON.`;

                        const result = await model.generateContent(prompt);
                        const text = result.response.text().replace(/```json/g, '').replace(/```/g, '').trim();
                        const analysis = JSON.parse(text);

                        // 4. Sauvegarde dans l'objet ressource
                        originalRes.aiAnalysis = analysis;

                        triggerUpdate();
                        showToast("Ressource analys√©e avec succ√®s !", "success");

                    } catch (e) {
                        console.error(e);
                        showToast("√âchec de l'analyse : " + e.message, "error");
                    } finally {
                        analyzingResId.value = null;
                    }
                };

          // --- GESTION ASSIGNATION √âQUIPE ---

          // 1. Assigner une personne sp√©cifique
          const assignUser = (outcome, targetUser) => {
            if (!outcome.assignees) outcome.assignees = [];

            // On √©vite les doublons
            if (!outcome.assignees.includes(targetUser)) {
              outcome.assignees.push(targetUser);
              logActivity(`a assign√© la t√¢che √† ${targetUser}`, outcome.id);
              showToast(`${targetUser} assign√© avec succ√®s`, "success");
              triggerUpdate();
            }
          };

          // 2. Retirer une personne sp√©cifique (en cliquant sur sa t√™te)
          const unassignUser = (outcome, targetUser) => {
            if (!outcome.assignees) return;
            outcome.assignees = outcome.assignees.filter(
              (u) => u !== targetUser
            );
            logActivity(`a d√©sassign√© ${targetUser}`, outcome.id);
            triggerUpdate();
          };

          // 3. Fonction wrapper pour le Kanban (retrouve l'objet par ID)
          const assignUserById = (outcomeId, targetUser) => {
            // Recherche de l'original dans la data
            let found = null;
            for (const d of digCompData.domains) {
              for (const c of d.competences) {
                found = c.outcomes.find((o) => o.id === outcomeId);
                if (found) break;
              }
              if (found) break;
            }
            if (found) assignUser(found, targetUser);
          };

          // Gestion du Drag & Drop de la fen√™tre
          const startDragVisio = (e) => {
            visioState.dragging = true;
            visioState.relX = e.clientX - visioState.x;
            visioState.relY = e.clientY - visioState.y;
            window.addEventListener("mousemove", onDragVisio);
            window.addEventListener("mouseup", stopDragVisio);
          };
          const onDragVisio = (e) => {
            if (!visioState.dragging) return;
            visioState.x = e.clientX - visioState.relX;
            visioState.y = e.clientY - visioState.relY;
          };
          const stopDragVisio = () => {
            visioState.dragging = false;
            window.removeEventListener("mousemove", onDragVisio);
            window.removeEventListener("mouseup", stopDragVisio);
          };
          const commonEmojis = [
            "üëç",
            "‚ù§Ô∏è",
            "üòÇ",
            "üòÆ",
            "üò¢",
            "üî•",
            "üéâ",
            "üëã",
            "‚úÖ",
            "‚ùå",
          ];
          const md = window.markdownit();

          onMounted(() => {
            auth.onAuthStateChanged((u) => {
              user.value = u;
              if (u) initApp(u);
            });
            document.addEventListener("mousemove", resetIdleTimer);
            document.addEventListener("keydown", resetIdleTimer);
            if (localStorage.getItem("theme") === "dark") {
              isDarkMode.value = true;
              document.documentElement.classList.add("dark");
            }
            cleanupOldMessages()
          });

          const resetIdleTimer = () => {
            if (!user.value) return;
            if (idleTimeout) clearTimeout(idleTimeout);
            if (user.value.state === "idle")
              db.collection("users")
                .doc(user.value.uid)
                .update({ state: "online" });
            idleTimeout = setTimeout(
              () =>
                db
                  .collection("users")
                  .doc(user.value.uid)
                  .update({ state: "idle" }),
              300000
            );
          };

          const initApp = (u) => {
            db.collection("digcomp_data")
              .doc("main_v2")
              .onSnapshot((doc) => {
                if (doc.exists) {
                  const d = doc.data();
                  if (d.tags) availableTags.value = d.tags;
                  const hydratedDomains = (d.domains || []).map((dom) => ({
                    ...dom,
                    competences: (dom.competences || []).map((comp) => {
                      const shortId = comp.id.split("/").pop();
                      if (OFFICIAL_TITLES[shortId])
                        comp.name = OFFICIAL_TITLES[shortId];
                      return {
                        ...comp,
                        outcomes: (comp.outcomes || []).map((o) => {
                          const mappings = o.mappings || {};
                          ["L1", "L2", "L3"].forEach((y) => {
                            if (!mappings[y])
                              mappings[y] = {
                                developed: false,
                                status: "none",
                                courseLink: "",
                              };
                            if (
                              mappings[y].developed &&
                              (!mappings[y].status ||
                                mappings[y].status === "none")
                            ) {
                              mappings[y].status = "validated";
                            }
                            if (!mappings[y].status)
                              mappings[y].status = "none";
                          });
                          return {
                            ...o,
                            description: o.description || o.text || "...",
                            tags: o.tags || [],
                            mappings,
                            comments: o.comments || [],
                          };
                        }),
                      };
                    }),
                  }));
                  digCompData.domains = hydratedDomains;
                }
              });

            db.collection("users")
              .doc(u.uid)
              .onSnapshot((doc) => {
                if (doc.exists) {
                  const d = doc.data();
                  if (d.lastChatOpen)
                    lastReadTime.value = new Date(d.lastChatOpen);
                  else {
                    lastReadTime.value = new Date();
                    db.collection("users")
                      .doc(u.uid)
                      .update({ lastChatOpen: new Date().toISOString() });
                  }
                  if (d.prefSound) notificationSound.value = d.prefSound;
                  if (d.apiKey) apiKey.value = d.apiKey;
                  if (d.aiModel) aiModel.value = d.aiModel;
                  if (d.pinned) pinnedCompetences.value = d.pinned;
                }
              });

            db.collection("audit_logs")
              .orderBy("timestamp", "desc")
              .limit(50)
              .onSnapshot((snap) => {
                historyLogs.value = snap.docs.map((d) => ({
                  id: d.id,
                  ...d.data(),
                }));
              });

            db.collection("notifications")
              .where("userId", "==", u.uid)
              .orderBy("timestamp", "desc")
              .limit(20)
              .onSnapshot((snap) => {
                userNotifications.value = snap.docs.map((d) => ({
                  id: d.id,
                  ...d.data(),
                }));
              });

            const beat = () =>
              db.collection("users").doc(u.uid).set(
                {
                  email: u.email,
                  lastSeen: new Date().toISOString(),
                  state: "online",
                },
                { merge: true }
              );
            beat();
            heartbeatInterval = setInterval(beat, 60000);
            db.collection("users").onSnapshot((snap) => {
              const now = new Date();
              const active = [];
              snap.forEach((d) => {
                if (now - new Date(d.data().lastSeen) < 3600000)
                  active.push(d.data());
              });
              connectedUsers.value = active;
            });

            db.collection("messages")
              .orderBy("timestamp", "asc")
              .limitToLast(50)
              .onSnapshot((snap) => {
                chatMessages.value = snap.docs.map((d) => ({
                  id: d.id,
                  ...d.data(),
                }));
                if (!showChat.value) {
                  const unread = chatMessages.value.filter(
                    (m) =>
                      m.timestamp &&
                      m.timestamp.toDate() > lastReadTime.value &&
                      m.sender !== u.email
                  );
                  unreadCount.value = unread.length;
                }
                snap.docChanges().forEach((change) => {
                  if (change.type === "added") {
                    const msg = change.doc.data();
                    const msgTime = msg.timestamp
                      ? msg.timestamp.toDate()
                      : new Date();
                    if (msg.sender !== u.email && msgTime > appStartTime) {
                      if (!showChat.value || document.hidden) {
                        playNotificationSound();
                        if (document.hidden)
                          sendBrowserNotification(msg.sender, msg.text);
                      }
                    }
                  }
                });
                nextTick(() => {
                  if (chatBox.value)
                    chatBox.value.scrollTop = chatBox.value.scrollHeight;
                });
              });
          };

          const toggleDarkMode = () => {
            isDarkMode.value = !isDarkMode.value;
            document.documentElement.classList.toggle("dark");
            localStorage.setItem("theme", isDarkMode.value ? "dark" : "light");
          };

          const logAction = (action, targetId, desc, year, oldVal, newVal) => {
            db.collection("audit_logs").add({
              timestamp: new Date().toISOString(),
              user: user.value.email.split("@")[0],
              action,
              targetId,
              desc: desc.substring(0, 50) + "...",
              year,
              oldVal,
              newVal,
            });
          };

          const notifyFollowers = async (outcomeId, message) => {
            const snap = await db
              .collection("users")
              .where("pinned", "array-contains", outcomeId)
              .get();
            const batch = db.batch();
            snap.forEach((doc) => {
              if (doc.id !== user.value.uid) {
                // Don't notify self
                const ref = db.collection("notifications").doc();
                batch.set(ref, {
                  userId: doc.id,
                  title: "Mise √† jour Favori",
                  message: message,
                  targetId: outcomeId,
                  timestamp: new Date().toISOString(),
                  read: false,
                });
              }
            });
            await batch.commit();
          };

          const getOutcomeDescription = (id) => {
            for (const d of digCompData.domains) {
              for (const c of d.competences) {
                const o = c.outcomes.find((x) => x.id === id);
                if (o) return o.description;
              }
            }
            return "";
          };

          const unreadNotifCount = computed(
            () => userNotifications.value.filter((n) => !n.read).length
          );

          const restoreState = (log) => {
            if (!confirm("Restaurer cet √©tat ?")) return;
            let found = null;
            for (const d of digCompData.domains) {
              for (const c of d.competences) {
                found = c.outcomes.find((o) => o.id === log.targetId);
                if (found) break;
              }
              if (found) break;
            }
            if (found) {
              if (log.action === "status_change") {
                found.mappings[log.year].status = log.oldVal;
                found.mappings[log.year].developed = log.oldVal !== "none";
              } else if (log.action === "link") {
                found.mappings[log.year].courseLink = log.oldVal;
              }
              triggerUpdate();
            }
          };

          const openLOHistory = (outcome) => {
            currentHistoryOutcomeTitle.value =
              outcome.description.substring(0, 40) + "...";
            currentLOHistory.value = historyLogs.value.filter((log) => {
              const matchId = log.targetId === outcome.id;
              const matchYear =
                currentView.value === "Overview"
                  ? true
                  : log.year === currentView.value;
              return matchId && matchYear;
            });
            showLOHistoryModal.value = true;
          };

          const generateAIContent = async (outcome, type) => {
            if (!apiKey.value) {
              alert(
                "Veuillez d'abord configurer votre cl√© API Gemini dans les Param√®tres."
              );
              showSettingsModal.value = true;
              return;
            }
            currentOutcomeForAI.value = outcome;
            currentAIType.value = type;
            showAIModal.value = true;
            aiLoading.value = true;
            aiError.value = "";
            aiResult.value = "";

            try {
              const genAI = new GoogleGenerativeAI(apiKey.value);
              const model = genAI.getGenerativeModel({ model: aiModel.value });

              let prompt = `Agis comme un expert en p√©dagogie informatique. Public: Etudiants Licence (Bac+1 √† +3).
                        Comp√©tence : ${outcome.description} (Niveau: ${outcome.level}).
                        T√¢che : G√©n√®re `;

              if (type === "course")
                prompt += `un plan de cours d√©taill√© avec : Introduction, 3 Concepts cl√©s expliqu√©s, Exemple concret, Conclusion.`;
              else if (type === "td")
                prompt += `un exercice de Travaux Dirig√©s (TD) progressif. √ânonce l'objectif, les pr√©requis, et 3 √©tapes de difficult√© croissante.`;
              else if (type === "qcm")
                prompt += `un QCM de 5 questions pour valider cette comp√©tence. Affiche la question, 4 choix, et la r√©ponse correcte expliqu√©e √† la fin.`;
              else if (type === "practice")
                prompt += `un sc√©nario de mise en situation pratique (Projet ou TP). Contexte professionnel, T√¢che √† r√©aliser, Crit√®res de r√©ussite.`;

              prompt += ` Format de sortie : Markdown propre et structur√©.`;

              const result = await model.generateContent(prompt);
              const response = await result.response;
              aiResult.value = response.text();
              showToast("Contenu g√©n√©r√© par l'IA !", "success");
              logActivity("a g√©n√©r√© une √©valuation IA", outcome.id);
            } catch (e) {
              aiError.value = "Erreur Gemini : " + e.message;
            } finally {
              aiLoading.value = false;
            }
          };

          const togglePin = (cid) => {
            let pins = [...pinnedCompetences.value];
            const index = pins.indexOf(cid);
            if (index > -1) pins.splice(index, 1);
            else pins.push(cid);
            pinnedCompetences.value = pins;
            db.collection("users").doc(user.value.uid).update({ pinned: pins });
          };

          const selectCompetenceById = (id) => {
            for (const d of digCompData.domains) {
              const c = d.competences.find((x) => x.id === id);
              if (c) {
                selectCompetence(c);
                return;
              }
            }
          };
          const openCommentModal = (o) => {
            currentOutcomeForComments.value = o;
            showCommentModal.value = true;
          };

          const addComment = () => {
            if (!newCommentText.value.trim()) return;
            const comment = {
              text: newCommentText.value,
              author: user.value.email.split("@")[0],
              date: new Date().toISOString(),
              year: currentView.value,
            };
            currentOutcomeForComments.value.comments.push(comment);
            newCommentText.value = "";
            triggerUpdate();
          };

          const deleteComment = (c) => {
            if (!confirm("Supprimer ?")) return;
            const idx = currentOutcomeForComments.value.comments.indexOf(c);
            if (idx > -1) {
              currentOutcomeForComments.value.comments.splice(idx, 1);
              triggerUpdate();
            }
          };

          const getFilteredComments = (outcome) => {
            if (!outcome || !outcome.comments) return [];
            if (currentView.value === "Overview") return outcome.comments; // Show all
            return outcome.comments.filter((c) => c.year === currentView.value); // Show specific
          };

          const getFilteredCommentsCount = (outcome) => {
            return getFilteredComments(outcome).length;
          };

          // RESOURCE MANAGEMENT
          const getResourcesCount = (outcome) => {
            if (currentView.value === "Overview") {
              return ["L1", "L2", "L3"].reduce(
                (acc, y) =>
                  acc +
                  (outcome.mappings[y].resources
                    ? outcome.mappings[y].resources.length
                    : 0),
                0
              );
            }
            return (outcome.mappings[currentView.value].resources || []).length;
          };

          const getAllResources = (outcome) => {
            if (currentView.value === "Overview") {
              let all = [];
              ["L1", "L2", "L3"].forEach((y) => {
                if (outcome.mappings[y].resources) {
                  all = all.concat(
                    outcome.mappings[y].resources.map((r) => ({
                      ...r,
                      year: y,
                    }))
                  );
                }
              });
              return all;
            }
            return (outcome.mappings[currentView.value].resources || []).map(
              (r) => ({ ...r, year: currentView.value })
            );
          };

          const addResource = (outcome) => {
            if (!outcome.newResTitle || !outcome.newResUrl) return;
            if (!outcome.mappings[currentView.value].resources)
              outcome.mappings[currentView.value].resources = [];

            const newRes = {
              id: Date.now(),
              title: outcome.newResTitle,
              url: outcome.newResUrl,
              user: user.value.email.split("@")[0],
              date: new Date().toISOString(),
            };

            outcome.mappings[currentView.value].resources.push(newRes);
            logActivity("a ajout√© une ressource", "");
            logAction(
              "add_resource",
              outcome.id,
              outcome.description,
              currentView.value,
              null,
              outcome.newResTitle
            );
            notifyFollowers(
              outcome.id,
              `Nouveau document en ${currentView.value}: ${outcome.newResTitle}`
            );
            outcome.newResTitle = "";
            outcome.newResUrl = "";
            triggerUpdate();
          };

          const getMappingData = (o, y) => {
            if (!o.mappings) o.mappings = {};
            if (!o.mappings[y])
              o.mappings[y] = {
                developed: false,
                status: "none",
                courseLink: "",
              };
            return o.mappings[y];
          };

          const updateMapping = (o, y, f, v) => {
            const oldVal = getMappingData(o, y)[f];
            getMappingData(o, y)[f] = v;
            const actionType =
              f === "developed" ? (v ? "check" : "uncheck") : "link";
            logAction(actionType, o.id, o.description, y, oldVal, v);

            if (field === "courseLink" && value.length > 5) {
              // On log seulement si c'est un lien significatif
              logActivity(
                "a mis √† jour le lien cours",
                `${outcome.id} (${year})`
              );
            }

            triggerUpdate();
          };
        
          const exportDataExcel = () => {
            const rows = [];
            digCompData.domains.forEach((d) => {
              d.competences.forEach((c) => {
                c.outcomes.forEach((o) => {
                  rows.push({
                    Domaine: d.name,
                    Competence: c.name,
                    Acquis: o.description,
                    Niveau: o.level,
                    // AJOUT DES TAGS (s√©par√©s par des virgules)
                    Composantes: (o.tags || []).join(", "),
                    // AJOUT DES STATUTS
                    Statut_L1: o.mappings.L1.status,
                    Statut_L2: o.mappings.L2.status,
                    Statut_L3: o.mappings.L3.status,
                    // AJOUT DES LIENS
                    Lien_L1: o.mappings.L1.courseLink || "",
                    Lien_L2: o.mappings.L2.courseLink || "",
                    Lien_L3: o.mappings.L3.courseLink || "",
                  });
                });
              });
            });
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DigComp_Complet");
            XLSX.writeFile(wb, "digcomp_export_complet.xlsx");
            showToast("Export g√©n√©r√© avec succ√®s !", "success");
          };
          const exportDataPDF = () => {
            const { jsPDF } = window.jspdf;
            // Mode Paysage ('l') pour avoir de la place
            const doc = new jsPDF("l", "mm", "a4");

            doc.setFontSize(14);
            doc.text(
              `Rapport D√©taill√© DigComp - Vue ${currentView.value}`,
              14,
              15
            );

            const tableData = [];

            digCompData.domains.forEach((d) => {
              d.competences.forEach((c) => {
                c.outcomes.forEach((o) => {
                  // On filtre pour ne pas faire un PDF de 100 pages : on affiche que si c'est "actif" dans la vue
                  const showRow =
                    currentView.value === "Overview"
                      ? true
                      : isStatusActive(o, currentView.value);

                  if (showRow) {
                    // R√©cup√©ration du lien selon la vue
                    let link = "";
                    if (currentView.value === "Overview") {
                      // En vue globale, on met juste "Oui" si lien existe
                      if (
                        o.mappings.L1.courseLink ||
                        o.mappings.L2.courseLink ||
                        o.mappings.L3.courseLink
                      )
                        link = "Voir Excel";
                    } else {
                      link = o.mappings[currentView.value].courseLink || "";
                    }

                    tableData.push([
                      c.id.split("/").pop(), // Code (ex: 1.1)
                      o.description.substring(0, 60) +
                        (o.description.length > 60 ? "..." : ""), // Desc tronqu√©e
                      o.level,
                      (o.tags || []).join("\n"), // Tags (un par ligne dans la case)
                      link, // Le lien
                    ]);
                  }
                });
              });
            });

            doc.autoTable({
              head: [
                ["Ref", "Acquis", "Niveau", "Composantes (Tags)", "Lien Cours"],
              ],
              body: tableData,
              startY: 20,
              styles: { fontSize: 8, overflow: "linebreak" },
              columnStyles: {
                1: { cellWidth: 90 }, // La description prend de la place
                4: { cellWidth: 60 }, // Le lien aussi
              },
            });

            doc.save(`digcomp_report_${currentView.value}.pdf`);
            showToast("Export g√©n√©r√© avec succ√®s !", "success");
          };

          const requestNotifPermission = () =>
            Notification.requestPermission().then((p) => {
              notifPermission.value = p;
              if (p === "granted")
                new Notification("DigComp", { body: "Activ√©!" });
            });
          const previewSound = (type) => {
            const t = notificationSound.value;
            notificationSound.value = type;
            playNotificationSound();
            notificationSound.value = t;
          };

          const playNotificationSound = () => {
            if (notificationSound.value === "fanfare") {
              new Audio(
                "https://www.myinstants.com/media/sounds/final-fantasy-v-music-victory-fanfare.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "chat") {
              new Audio("https://www.myinstants.com/media/sounds/m-e-o-w.mp3")
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "college") {
              new Audio(
                "https://www.myinstants.com/media/sounds/sonnerie-college.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "SNCF") {
              new Audio(
                "https://www.myinstants.com/media/sounds/sncf-france-jingle.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "erreur") {
              new Audio("https://www.myinstants.com/media/sounds/erro.mp3")
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "motus") {
              new Audio(
                "https://www.myinstants.com/media/sounds/boule-noire.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "airhorn") {
              new Audio(
                "https://www.myinstants.com/media/sounds/dj-airhorn-sound-effect-kingbeatz_1.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "heehee") {
              new Audio(
                "https://www.myinstants.com/media/sounds/michael-jackson-hee-hee.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "romantique") {
              new Audio(
                "https://www.myinstants.com/media/sounds/romanceeeeeeeeeeeeee.mp3"
              )
                .play()
                .catch((e) => console.log(e));
                } else if (notificationSound.value === "tennis") {
              new Audio(
                "https://www.myinstants.com/media/sounds/tennis-shot.mp3"
              )
                .play()
                .catch((e) => console.log(e));

            } else if (notificationSound.value === "gandalf") {
              new Audio(
                "https://www.myinstants.com/media/sounds/gandalf_shallnotpass.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "kawoosh") {
              new Audio(
                "https://www.myinstants.com/media/sounds/spellgate-activation.mp3"
              )
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "zat") {
              new Audio("https://www.myinstants.com/media/sounds/zat-gun-2.mp3")
                .play()
                .catch((e) => console.log(e));
            } else if (notificationSound.value === "beep") {
              const ctx = new (window.AudioContext ||
                window.webkitAudioContext)();
              const o = ctx.createOscillator();
              const g = ctx.createGain();
              o.connect(g);
              g.connect(ctx.destination);
              o.frequency.value = 800;
              g.gain.setValueAtTime(0.1, ctx.currentTime);
              g.gain.exponentialRampToValueAtTime(
                0.00001,
                ctx.currentTime + 0.5
              );
              o.start();
              o.stop(ctx.currentTime + 0.5);
            }
          };

          const saveSettings = () => {
            db.collection("users").doc(user.value.uid).update({
              prefSound: notificationSound.value,
              apiKey: apiKey.value,
              aiModel: aiModel.value,
            });
            showSettingsModal.value = false;
          };
          const sendBrowserNotification = (s, t) => {
            if (Notification.permission === "granted") {
              const n = new Notification(s.split("@")[0], { body: t });
              n.onclick = () => {
                window.focus();
                toggleChat();
              };
            }
          };
          const login = async () => {
            loading.value = true;
            if (Notification.permission !== "granted")
              await Notification.requestPermission();
            notifPermission.value = Notification.permission;
            try {
              await auth.signInWithEmailAndPassword(
                authForm.email,
                authForm.password
              );
            } catch (e) {
              authError.value = e.message;
            } finally {
              loading.value = false;
            }
          };
          const logout = () => auth.signOut();
          const toggleChat = () => {
            showChat.value = !showChat.value;
            if (showChat.value) {
              unreadCount.value = 0;
              nextTick(
                () => (chatBox.value.scrollTop = chatBox.value.scrollHeight)
              );
              db.collection("users")
                .doc(user.value.uid)
                .update({ lastChatOpen: new Date().toISOString() });
              lastReadTime.value = new Date();
            }
          };
          const toggleReaction = (msg, e) => {
            const r = msg.reactions || {};
            let u = r[e] || [];
            if (u.includes(user.value.email))
              u = u.filter((x) => x !== user.value.email);
            else u.push(user.value.email);
            if (u.length === 0) delete r[e];
            else r[e] = u;
            db.collection("messages").doc(msg.id).update({ reactions: r });
          };

          const triggerUpdate = async () => {
            if (user.value)
              await db
                .collection("digcomp_data")
                .doc("main_v2")
                .set(
                  {
                    domains: JSON.parse(JSON.stringify(digCompData.domains)),
                    tags: availableTags.value,
                    lastUpdated: new Date().toISOString(),
                  },
                  { merge: true }
                );
          };
          const handleTyping = () => {
            if (typingTimeout) clearTimeout(typingTimeout);
            db.collection("users")
              .doc(user.value.uid)
              .set({ isTyping: true }, { merge: true });
            typingTimeout = setTimeout(
              () =>
                db
                  .collection("users")
                  .doc(user.value.uid)
                  .set({ isTyping: false }, { merge: true }),
              2000
            );
          };
          const sendMessage = async () => {
            if (!newMessage.value.trim()) return;
            if (typingTimeout) clearTimeout(typingTimeout);
            db.collection("users")
              .doc(user.value.uid)
              .set({ isTyping: false }, { merge: true });
            await db.collection("messages").add({
              text: newMessage.value,
              sender: user.value.email,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
            newMessage.value = "";
          };
          const openAddModal = () => {
            newOutcome.description = "";
            showAddModal.value = true;
          };
          const addCustomOutcome = () => {
            if (!currentCompetence.value) return;
            const d = digCompData.domains.find((x) =>
              x.competences.some((c) => c.id === currentCompetence.value.id)
            );
            const c = d.competences.find(
              (x) => x.id === currentCompetence.value.id
            );
            c.outcomes.push({
              id: `C-${Date.now()}`,
              description: newOutcome.description,
              level: newOutcome.level,
              isAI: newOutcome.isAI,
              isCustom: true,
              mappings: {
                L1: { developed: false },
                L2: { developed: false },
                L3: { developed: false },
              },
              createdBy: user.value.email,
            });
            showAddModal.value = false;
            triggerUpdate();
          };
          const deleteOutcome = (o) => {
            if (!confirm("Supprimer?")) return;
            const d = digCompData.domains.find((x) =>
              x.competences.some((c) => c.id === currentCompetence.value.id)
            );
            const c = d.competences.find(
              (x) => x.id === currentCompetence.value.id
            );
            const i = c.outcomes.findIndex((x) => x.id === o.id);
            if (i > -1) {
              c.outcomes.splice(i, 1);
              triggerUpdate();
            }
          };
          const selectCompetence = (c) => {
            currentCompetence.value = c;
            isMobileMenuOpen.value = false;
          };
          const currentDomainName = computed(() => {
            if (!currentCompetence.value) return "";
            const d = digCompData.domains.find((x) =>
              x.competences.some((c) => c.id === currentCompetence.value.id)
            );
            return d ? d.name : "";
          });
          const filteredTree = computed(() => {
            if (!searchQuery.value && !selectedComponentTag.value)
              return digCompData.domains;
            return digCompData.domains
              .map((d) => ({
                ...d,
                competences: d.competences.filter((c) =>
                  c.outcomes.some((o) => {
                    const matchText = (o.description || "")
                      .toLowerCase()
                      .includes(searchQuery.value.toLowerCase());
                    const matchTag = selectedComponentTag.value
                      ? o.tags.includes(selectedComponentTag.value)
                      : true;
                    return matchText && matchTag;
                  })
                ),
              }))
              .filter((d) => d.competences.length > 0);
          });
          const displayedOutcomes = computed(() => {
            if (!currentCompetence.value) return [];
            const d = digCompData.domains.find((x) =>
              x.competences.some((c) => c.id === currentCompetence.value.id)
            );
            if (!d) return [];
            const c = d.competences.find(
              (x) => x.id === currentCompetence.value.id
            );
            let out = c.outcomes;
            // --- NOUVEAU : FILTRE MES T√ÇCHES ---
            if (onlyMyTasks.value) {
              // On v√©rifie que l'utilisateur est connect√©
              if (user.value) {
                const myId = user.value.email.split("@")[0];
                // On ne garde que les LO o√π mon ID est dans la liste 'assignees'
                out = out.filter(
                  (o) => o.assignees && o.assignees.includes(myId)
                );
              } else {
                return []; // Si pas connect√© et filtre actif -> rien
              }
            }
            // -----------------------------------
            if (searchQuery.value)
              out = out.filter((o) =>
                (o.description || "")
                  .toLowerCase()
                  .includes(searchQuery.value.toLowerCase())
              );
            if (currentFilter.value !== "All")
              out = out.filter((o) => o.level === currentFilter.value);
            if (selectedComponentTag.value)
              out = out.filter((o) =>
                o.tags.includes(selectedComponentTag.value)
              );
            if (showCheckedOnly.value)
              out = out.filter((o) => {
                if (currentView.value === "Overview")
                  return ["L1", "L2", "L3"].some((y) => isStatusActive(o, y));
                return isStatusActive(o, currentView.value);
              });
            return out;
          });
          const translateLevel = (l) =>
            ({
              Basic: "Fondamental",
              Intermediate: "Interm√©diaire",
              Advanced: "Avanc√©",
              "Highly advanced": "Expert",
            }[l] || l);
          const getLevelBadgeClass = (l) =>
            ({
              Basic: "badge-Basic",
              Intermediate: "badge-Intermediate",
              Advanced: "badge-Advanced",
              "Highly advanced": "badge-Highly-advanced",
            }[l] || "bg-gray-100");
          const getViewBadgeClass = () => {
            if (currentView.value === "L1")
              return "bg-red-100 text-red-700 border-red-200";
            if (currentView.value === "L2")
              return "bg-amber-100 text-amber-700 border-amber-200";
            if (currentView.value === "L3")
              return "bg-emerald-100 text-emerald-700 border-emerald-200";
            return "bg-slate-700 text-white border-slate-700";
          };
          const viewBgClass = computed(() => {
            if (isDarkMode.value) return "bg-darkbg";
            switch (currentView.value) {
              case "L1":
                return "bg-red-50/50";
              case "L2":
                return "bg-amber-50/50";
              case "L3":
                return "bg-green-50/50";
              default:
                return "bg-gray-50";
            }
          });
          const highlightText = (t) =>
            searchQuery.value
              ? t.replace(
                  new RegExp(`(${searchQuery.value})`, "gi"),
                  '<span class="bg-yellow-200 text-black font-bold">$1</span>'
                )
              : t;
          const calculateCompetenceCoverage = (c) => {
            if (!c.outcomes.length) return 0;
            let checked = 0;
            c.outcomes.forEach((o) => {
              if (currentView.value === "Overview") {
                if (isCoveredAnywhere(o)) checked++;
              } else {
                if (isStatusActive(o, currentView.value)) checked++;
              }
            });
            return (checked / c.outcomes.length) * 100;
          };
          const calculateDomainCoverage = (d) => {
            let t = 0,
              c = 0;
            d.competences.forEach((comp) => {
              t += comp.outcomes.length;
              comp.outcomes.forEach((o) => {
                if (currentView.value === "Overview") {
                  if (isCoveredAnywhere(o)) c++;
                } else {
                  if (isStatusActive(o, currentView.value)) c++;
                }
              });
            });
            return t ? (c / t) * 100 : 0;
          };
          const usersTypingText = computed(() => {
            if (!user.value) return "";
            return connectedUsers.value
              .filter((u) => u.isTyping && u.email !== user.value.email)
              .map((u) => u.email.split("@")[0])
              .join(", ");
          });
          const getUserColor = (email) => {
            const colors = [
              "bg-red-500",
              "bg-orange-500",
              "bg-amber-500",
              "bg-green-500",
              "bg-emerald-500",
              "bg-teal-500",
              "bg-cyan-500",
              "bg-blue-500",
              "bg-indigo-500",
              "bg-violet-500",
              "bg-purple-500",
              "bg-fuchsia-500",
              "bg-pink-500",
              "bg-rose-500",
            ];
            let hash = 0;
            for (let i = 0; i < email.length; i++)
              hash = email.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
          };
          const markdownToHtml = (t) => md.render(t);

          // WORKFLOW CYCLE
          const updateStatus = (o, y, newStatus) => {
            const statusLabels = {
              validated: "üü¢ Valid√©",
              draft: "üü† Brouillon",
              review: "üü° En relecture", // Ajout
              obsolete: "‚ö™ Obsol√®te",
              none: "üî¥ A faire",
            };
            const current = getMappingData(o, y).status || "none";
            if (!o.mappings) o.mappings = {};
            if (!o.mappings[y])
              o.mappings[y] = { developed: false, courseLink: "" };
            o.mappings[y].status = newStatus;
            o.mappings[y].developed =
              newStatus === "validated" || newStatus === "draft"; // Considered active for stats

            logAction(
              "status_change",
              o.id,
              o.description,
              y,
              current,
              newStatus
            );
            logActivity(`a pass√© en ${label}`, `${outcome.id} (${year})`);
            if (newStatus === "validated")
              notifyFollowers(o.id, `Comp√©tence valid√©e en ${y}`);
            triggerUpdate();
          };

          const fetchSyllabus = async () => {
            if (!importUrl.value) return;
            importLoading.value = true;
            try {
              // Utilisation d'un proxy pour contourner les restrictions CORS
              const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(
                importUrl.value
              )}`;
              const response = await fetch(proxyUrl);
              const data = await response.json();
              if (data.contents) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, "text/html");
                // Extraction basique du texte (limit√© √† 15000 caract√®res pour l'IA)
                const textContent = doc.body.innerText
                  .replace(/\s+/g, " ")
                  .substring(0, 15000);
                await analyzeSyllabus(textContent);
              } else {
                throw new Error("Impossible de lire le contenu.");
              }
            } catch (e) {
              alert(
                "Erreur de r√©cup√©ration : " +
                  e.message +
                  "\nLe site est peut-√™tre prot√©g√©."
              );
              importLoading.value = false;
            }
          };

          // --- COLLABORATION : ASSIGNATION & RADAR ---

          // 1. Gestion du Radar d'Activit√©
          const showActivityPanel = ref(false); // Ouvrir/Fermer le panneau
          const activities = ref([]);

          // Fonction pour enregistrer une action
          const logActivity = (action, detail) => {
            if (!user.value) return;
            db.collection("activity_feed").add({
              user: user.value.email.split("@")[0],
              action: action, // ex: "A valid√©", "A comment√©"
              detail: detail, // ex: "LO 1.2", "Ressource vid√©o"
              date: new Date().toISOString(),
            });
          };

          // √âcoute en temps r√©el du flux d'activit√©
          db.collection("activity_feed")
            .orderBy("date", "desc")
            .limit(50)
            .onSnapshot((snap) => {
              activities.value = snap.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
            });

          // 2. Gestion des Assignations
          const onlyMyTasks = ref(false); // Le filtre "Mes T√¢ches"

          const toggleAssignment = (outcome) => {
            if (!user.value) return;
            const me = user.value.email.split("@")[0];

            // Si pas de liste, on la cr√©e
            if (!outcome.assignees) outcome.assignees = [];

            if (outcome.assignees.includes(me)) {
              // On se retire
              outcome.assignees = outcome.assignees.filter((u) => u !== me);
              logActivity("s'est d√©sassign√© de", outcome.id);
              showToast("Vous n'√™tes plus assign√©", "info");
            } else {
              // On s'ajoute
              outcome.assignees.push(me);
              logActivity("s'est assign√©", outcome.id);
              showToast("T√¢che assign√©e !", "success");
            }
            triggerUpdate(); // Sauvegarde
          };

          const analyzeSyllabus = async (text) => {
            try {
              if (!apiKey.value) {
                alert(
                  "Veuillez configurer votre cl√© API Gemini dans les param√®tres."
                );
                importLoading.value = false;
                return;
              }

              const model = new GoogleGenerativeAI(
                apiKey.value
              ).getGenerativeModel({ model: aiModel.value });

              // On cr√©e une version all√©g√©e de l'arbre pour √©conomiser des tokens
              const simplifiedTree = digCompData.domains.map((d) => ({
                domain: d.name,
                competences: d.competences.flatMap((c) =>
                  c.outcomes.map((o) => ({ id: o.id, txt: o.description }))
                ),
              }));

              const prompt = `Analyse ce cours : "${text}".
                        Compare-le avec ce r√©f√©rentiel de comp√©tences JSON : ${JSON.stringify(
                          simplifiedTree
                        )}.
                        Trouve les 3 √† 8 comp√©tences les plus pertinentes qui sont enseign√©es dans ce cours.
                        Format de r√©ponse OBLIGATOIRE : Un tableau JSON brut (sans markdown) : [{"id": "ID_EXACT_DU_JSON", "justification": "Court texte expliquant pourquoi", "level": "Basic, Intermediate, Advanced ou Highly advanced"}].`;

              const result = await model.generateContent(prompt);
              const responseText = (await result.response).text();
              // Nettoyage du markdown si pr√©sent
              const jsonStr = responseText
                .replace(/```json/g, "")
                .replace(/```/g, "")
                .trim();

              const parsed = JSON.parse(jsonStr);
              // On ajoute une propri√©t√© 'selected' pour l'UI
              importAnalysisResult.value = parsed.map((i) => ({
                ...i,
                selected: true,
              }));

              showImportModal.value = false;
              showImportConfirmModal.value = true;
            } catch (e) {
              alert("Erreur analyse IA : " + e.message);
            } finally {
              importLoading.value = false;
            }
          };

          // --- CHAT WITH DATA (Assistant R√©f√©rentiel) ---
const showDataChatModal = ref(false);
const dataChatQuery = ref("");
const dataChatResponse = ref("");
const dataChatLoading = ref(false);

// 1. Fonction pour all√©ger le JSON avant envoi (Token optimization)
const simplifyTreeForAnalysis = () => {
  return digCompData.domains.map(d => ({
    domain: d.name,
    competences: d.competences.map(c => ({
      id: c.id,
      name: c.name,
      outcomes: c.outcomes.map(o => ({
        id: o.id,
        desc: o.description.substring(0, 100), // On tronque pour √©conomiser
        level: o.level,
        // On extrait juste l'essentiel des statuts
        L1: { status: o.mappings.L1.status, hasRes: (o.mappings.L1.resources || []).length > 0 },
        L2: { status: o.mappings.L2.status, hasRes: (o.mappings.L2.resources || []).length > 0 },
        L3: { status: o.mappings.L3.status, hasRes: (o.mappings.L3.resources || []).length > 0 },
        assignees: o.assignees || []
      }))
    }))
  }));
};

// 2. La fonction d'appel √† Gemini
const askDataAssistant = async () => {
  if (!apiKey.value) {
    alert("Veuillez configurer la cl√© API Gemini dans les param√®tres.");
    return;
  }
  if (!dataChatQuery.value.trim()) return;

  dataChatLoading.value = true;
  dataChatResponse.value = "";

  try {
    const genAI = new GoogleGenerativeAI(apiKey.value);
    const model = genAI.getGenerativeModel({ model: aiModel.value });

    const simplifiedData = simplifyTreeForAnalysis();
    
    const prompt = `
      Tu es un analyste de donn√©es p√©dagogiques. Voici l'√©tat actuel du projet DigComp au format JSON :
      ${JSON.stringify(simplifiedData)}

      Analyse ces donn√©es pour r√©pondre √† la question de l'utilisateur.
      Sois pr√©cis, cite les IDs des comp√©tences si n√©cessaire. Fais des statistiques si demand√©.
      
      Question utilisateur : "${dataChatQuery.value}"
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    dataChatResponse.value = response.text();
  } catch (e) {
    dataChatResponse.value = "Erreur : " + e.message;
  } finally {
    dataChatLoading.value = false;
  }
};


          const applyImport = () => {
            const targetYear =
              currentView.value === "Overview" ? "L1" : currentView.value;
            let count = 0;

            importAnalysisResult.value.forEach((item) => {
              if (item.selected) {
                // Recherche du LO correspondant dans l'arbre
                for (const d of digCompData.domains) {
                  for (const c of d.competences) {
                    const outcome = c.outcomes.find((o) => o.id === item.id);
                    if (outcome) {
                      // On utilise les fonctions existantes pour la mise √† jour
                      updateStatus(outcome, targetYear, "validated");
                      updateMapping(
                        outcome,
                        targetYear,
                        "courseLink",
                        importUrl.value
                      );
                      count++;
                    }
                  }
                }
              }
            });

            showImportConfirmModal.value = false;
            importUrl.value = "";
            showToast("Importation termin√©e avec succ√®s", "success");
          };

          const getStatusClass = (status) => {
            switch (status) {
              case "validated":
                return "bg-green-100 text-green-700 border-green-200";
              case "draft":
                return "bg-orange-100 text-orange-700 border-orange-200";
              // AJOUT ICI
              case "review":
                return "bg-yellow-100 text-yellow-800 border-yellow-200";
              case "obsolete":
                return "bg-red-100 text-red-700 border-red-200";
              default:
                return "bg-gray-100 text-gray-500 border-gray-200";
            }
          };
          const getStatusIcon = (status) => {
            if (status === "validated") return "ph-check-circle";
            if (status === "draft") return "ph-pencil-simple";
            if (status === "review") return "ph-eye"; // Ic√¥ne "Oeil" pour relecture
            if (status === "obsolete") return "ph-trash";
            return "ph-circle";
          };

          const getStatusLabel = (status) => {
            const labels = {
              validated: "Valid√©",
              draft: "Brouillon",
              review: "En relecture", // Ajout
              obsolete: "Obsol√®te",
              none: "Non trait√©",
            };
            return labels[status] || status;
          };
          const isStatusActive = (o, y) => {
            const s = getMappingData(o, y).status;
            return s === "validated" || s === "draft";
          };

          const isCoveredAnywhere = (o) =>
            o.mappings && ["L1", "L2", "L3"].some((y) => isStatusActive(o, y));

          // TAGS
          const addTag = (o, t) => {
            if (!t || o.tags.includes(t)) return;
            o.tags.push(t);
            triggerUpdate();
          };
          const removeTag = (o, t) => {
            const i = o.tags.indexOf(t);
            if (i > -1) {
              o.tags.splice(i, 1);
              triggerUpdate();
            }
          };

          // DASHBOARD LOGIC
          const dashboardStats = reactive({
            totalLOs: 0,
            globalCoverage: 0,
            draftCount: 0,
            noResourceCount: 0,
          });
          const renderCharts = () => {
            let counts = {
              L1: 0,
              L2: 0,
              L3: 0,
              draft: 0,
              noRes: 0,
              total: 0,
              domains: {},
            };
            digCompData.domains.forEach((d) => {
              let dVal = 0;
              d.competences.forEach((c) => {
                c.outcomes.forEach((o) => {
                  counts.total++;
                  ["L1", "L2", "L3"].forEach((y) => {
                    if (o.mappings[y].status === "validated") {
                      counts[y]++;
                      dVal++;
                    }
                    if (o.mappings[y].status === "draft") counts.draft++;
                    if (
                      o.mappings[y].status === "validated" &&
                      (!o.mappings[y].resources ||
                        o.mappings[y].resources.length === 0)
                    )
                      counts.noRes++;
                  });
                });
              });
              counts.domains[d.name] = dVal;
            });

            dashboardStats.totalLOs = counts.total;
            dashboardStats.globalCoverage = Math.round(
              (counts.L3 / counts.total) * 100
            ); // Simplification L3 = target
            dashboardStats.draftCount = counts.draft;
            dashboardStats.noResourceCount = counts.noRes;

            if (dashBarChart) dashBarChart.destroy();
            dashBarChart = new Chart(document.getElementById("dashBarChart"), {
              type: "bar",
              data: {
                labels: ["L1", "L2", "L3"],
                datasets: [
                  {
                    label: "Valid√©s",
                    data: [counts.L1, counts.L2, counts.L3],
                    backgroundColor: ["#FCA5A5", "#FCD34D", "#6EE7B7"],
                  },
                ],
              },
            });

            if (dashDoughnutChart) dashDoughnutChart.destroy();
            dashDoughnutChart = new Chart(
              document.getElementById("dashDoughnutChart"),
              {
                type: "doughnut",
                data: {
                  labels: ["Valid√©s", "Brouillon", "Manque Ressource"],
                  datasets: [
                    {
                      data: [
                        counts.L1 + counts.L2 + counts.L3,
                        counts.draft,
                        counts.noRes,
                      ],
                      backgroundColor: ["#10B981", "#F59E0B", "#EF4444"],
                    },
                  ],
                },
              }
            );

            if (dashRadarChart) dashRadarChart.destroy();
            dashRadarChart = new Chart(
              document.getElementById("dashRadarChart"),
              {
                type: "radar",
                data: {
                  labels: Object.keys(counts.domains),
                  datasets: [
                    {
                      label: "Couverture",
                      data: Object.values(counts.domains),
                      backgroundColor: "rgba(59, 130, 246, 0.2)",
                      borderColor: "#3B82F6",
                    },
                  ],
                },
                options: { scales: { r: { beginAtZero: true } } },
              }
            );
          };

          const changeView = (v) => {
            currentView.value = v;
            if (v === "Dashboard") nextTick(renderCharts);
          };

          return {
            digCompData,
            currentCompetence,
            user,
            connectedUsers,
            authForm,
            authError,
            loading,
            isSyncing,
            searchQuery,
            currentFilter,
            currentView,
            filteredTree,
            displayedOutcomes,
            currentDomainName,
            isMobileMenuOpen,
            isDarkMode,
            showCheckedOnly,
            selectedComponentTag,
            availableTags,
            login,
            logout,
            selectCompetence,
            updateMapping,
            getMappingData,
            isCoveredAnywhere,
            showAddModal,
            newOutcome,
            openAddModal,
            addCustomOutcome,
            deleteOutcome,
            showChat,
            showEmojiPicker,
            showSettingsModal,
            notificationSound,
            chatMessages,
            newMessage,
            chatBox,
            unreadCount,
            sendMessage,
            handleTyping,
            toggleChat,
            toggleReaction,
            previewSound,
            saveSettings,
            translateLevel,
            getLevelBadgeClass,
            getViewBadgeClass,
            viewBgClass,
            highlightText,
            calculateCompetenceCoverage,
            calculateDomainCoverage,
            exportDataExcel,
            exportDataPDF,
            requestNotifPermission,
            notifPermission,
            commonEmojis,
            usersTypingText,
            toggleDarkMode,
            togglePin,
            selectCompetenceById,
            pinnedCompetences,
            getCompetenceName: (id) => {
              for (const d of digCompData.domains)
                for (const c of d.competences) if (c.id === id) return c.name;
              return id;
            },
            openCommentModal,
            showCommentModal,
            currentOutcomeForComments,
            newCommentText,
            addComment,
            deleteComment,
            getUserColor,
            showHistoryModal,
            historyLogs,
            restoreState,
            showAIModal,
            aiResult,
            aiLoading,
            aiError,
            generateAIContent,
            markdownToHtml,
            apiKey,
            aiModel,
            currentAIType,
            getFilteredComments,
            getFilteredCommentsCount,
            openLOHistory,
            showLOHistoryModal,
            currentLOHistory,
            currentHistoryOutcomeTitle,
            getResourcesCount,
            getAllResources,
            addResource,
            removeResource,
            updateStatus,
            getStatusClass,
            getStatusIcon,
            getStatusLabel,
            isStatusActive,
            userNotifications,
            unreadNotifCount,
            showNotifDropdown,
            changeView,
            dashboardStats,
            addTag,
            removeTag,
            getLongName,
            showImportModal,
            showImportConfirmModal,
            importUrl,
            importLoading,
            importAnalysisResult,
            fetchSyllabus,
            applyImport,
            getOutcomeDescription,
            visioState,
            toggleVisio,
            startDragVisio,
            showTimeMachineModal,
            snapshots,
            newSnapshotName,
            loadSnapshots,
            createSnapshot,
            restoreSnapshot,
            exportMoodleXML,
            activeLocks,
            requestLock,
            isLocked,
            getLockerName,
            kanbanYear,
            kanbanColumns,
            draggedOutcome,
            onDrop,
            showSunburstModal,
            openSunburst,
            exportToPixExcel,
            showHunterModal,
            openResourceHunter,
            launchHunter,
            hunterLoading,
            hunterResults,
            adoptResource,
            removeResource,
            toasts,
            showToast,
            removeToast,
            showActivityPanel,
            activities,
            logActivity,
            onlyMyTasks,
            toggleAssignment,
            assignUser,
            unassignUser,
            assignUserById,
            toggleAssignmentById,
            hunterSearchTerms,
            magicUrlInput,
            magicLoading,
            shortUrl,
            handleMagicPaste,
            kanbanOverview,
            fetchSmartTitle,
            showEditResModal,
            editResForm,
            openEditResource,
            saveEditedResource,
            showDataChatModal,
  dataChatQuery,
  dataChatResponse,
  dataChatLoading,
  askDataAssistant,
            getDiffHtml, editingOutcomeId, tempDescription, startEditDescription,saveDescription,
            handlePaste,
            fileInput, triggerFileInput, handleFileUpload, formatMessage, analyzeResourceContent, analyzingResId
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>